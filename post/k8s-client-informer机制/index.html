<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>K8s Client Informer mechanism - Lulu</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="K8s Client Informer mechansim">
		<meta property="og:title" content="K8s Client Informer mechanism" />
<meta property="og:description" content="K8s Client Informer mechansim" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sunhao1256.github.io/post/k8s-client-informer%E6%9C%BA%E5%88%B6/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-03-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-16T00:00:00+00:00" />


		<meta itemprop="name" content="K8s Client Informer mechanism">
<meta itemprop="description" content="K8s Client Informer mechansim"><meta itemprop="datePublished" content="2023-03-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-03-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="5973">
<meta itemprop="keywords" content="kunbernetes," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s Client Informer mechanism"/>
<meta name="twitter:description" content="K8s Client Informer mechansim"/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Lulu" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/placeholder.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Lulu</div>
					<div class="logo__tagline">Lulu is arrongant cat</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item menu__item--active">
			<a class="menu__link" href="/post/k8s-client-informer%E6%9C%BA%E5%88%B6/">
				
				<span class="menu__text">K8s Client Informer mechanism</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8s Client Informer mechanism</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Frank Silva</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2023-03-16T00:00:00Z">2023-03-16</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/cloud-native/" rel="category">Cloud Native</a>
	</span>
</div></div>
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#控制器-controller">控制器 (Controller)</a></li>
    <li><a href="#控制器的工作原理kubernetes-api">控制器的工作原理：Kubernetes API</a>
      <ul>
        <li><a href="#watch接口演示">watch接口演示</a></li>
      </ul>
    </li>
    <li><a href="#控制器的实现informer">控制器的实现：Informer</a>
      <ul>
        <li><a href="#client-go使用">client-go使用</a></li>
        <li><a href="#listwatcher">ListWatcher</a></li>
        <li><a href="#reflector">Reflector</a></li>
        <li><a href="#controller">Controller</a></li>
        <li><a href="#informer">Informer</a></li>
        <li><a href="#sharedinformer">SharedInformer</a></li>
        <li><a href="#indexer">Indexer</a></li>
        <li><a href="#sharedindexinformer">SharedIndexInformer</a></li>
        <li><a href="#informerfactory">InformerFactory</a></li>
        <li><a href="#workerqueue">Workerqueue</a></li>
        <li><a href="#crd-informer">Crd Informer</a></li>
      </ul>
    </li>
    <li><a href="#最佳实战-sample-controller">最佳实战 Sample Controller</a>
      <ul>
        <li><a href="#crd">Crd</a></li>
        <li><a href="#code-generator">Code-generator</a></li>
        <li><a href="#samplecontroller执行">SampleController执行</a></li>
        <li><a href="#应用中心查询应用状态">应用中心查询应用状态</a></li>
      </ul>
    </li>
    <li><a href="#kubebuilder">Kubebuilder</a>
      <ul>
        <li><a href="#让cm变成云原生cm">让CM变成云原生CM</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<h1 id="k8s-client-informer机制">K8s Client Informer机制</h1>
<h2 id="背景">背景</h2>
<p>在开发云原生数据库时，底层采用开源的<a href="https://github.com/kubedb">kubedb</a>作为技术实现方案，查看了kubedb的源码，发现其最核心的机制是k8s Controller机制。可见使用controller机制是将传统技术变为云原生技术的关键。</p>
<h2 id="控制器-controller">控制器 (Controller)</h2>
<blockquote>
<p>首先，Kubernetes 通过<a href="https://link.juejin.cn/?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fconcepts%2Farchitecture%2Fcontroller%2F"><strong>控制器 (controller)</strong></a> 来维护集群的状态。比如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Ftree%2Fmaster%2Fpkg%2Fcontroller%2Freplicaset">ReplicaSetController</a> 负责维护 ReplicaSet 对应的 Pod 数量，无论是 Pod 崩溃，被删除，还是 ReplicaSet 的 Replicas 配置发生变更，ReplicaSetController 都会采取必要的操作以维持各个 ReplicaSet 的 Selector 对应的 Pod 数量与 Replicas 一致。</p>
<p>除了 ReplicaSetController 外，Kubernetes 还提供了很多<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Ftree%2Fmaster%2Fpkg%2Fcontroller">内置的控制器</a>，包括 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Ftree%2Fmaster%2Fpkg%2Fcontroller%2Fendpoint">EndpointController</a>, <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Ftree%2Fmaster%2Fpkg%2Fcontroller%2Fnamespace">NamespaceController</a>, <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fkubernetes%2Ftree%2Fmaster%2Fpkg%2Fcontroller%2Fserviceaccount">ServiceAccountController</a> 等等。</p>
</blockquote>
<h2 id="控制器的工作原理kubernetes-api">控制器的工作原理：Kubernetes API</h2>
<blockquote>
<p>Kubernetes 控制面 (control plane) 的核心是 <strong>API 服务器 (API server)</strong>。除了CRUD的接口，API server还提供了watch接口，方便用户实时获取集群状态。有了这个接口，控制器才得以无延迟（准确地说是低延迟）地对状态变更作出响应。这里指的 &ldquo;状态变更&rdquo;，就是我们常说的<strong>事件 (event)</strong>。</p>
</blockquote>
<h3 id="watch接口演示">watch接口演示</h3>
<p><img src="https://pic-frank.oss-cn-beijing.aliyuncs.com/img/202303171049067.gif" alt="Screen Recording 2023-03-17 at 10.37.24"></p>
<p>watch是基于客户的角度进行响应，所以可以看到tmp下的config在没watch之前就存在一个kube-root-ca.crt，一旦watch后kube-root-ca.crt对于client来说是added的，所以会触发新增事件。</p>
<p>如果我想要只监听未来发生的事件，watch提供了resourceVersion参数，我们可以先进行一次get，得到当前的configMapList的resourceVersion，再调用接口，实例如下：</p>
<p><img src="https://pic-frank.oss-cn-beijing.aliyuncs.com/img/202303171101510.gif" alt="Screen Recording 2023-03-17 at 10.58.34"></p>
<h2 id="控制器的实现informer">控制器的实现：Informer</h2>
<blockquote>
<p>有了接口，我们就足以对集群状态进行观察和控制，但是，控制回路是一个无限循环的过程，每一次向服务器发送的请求，和每一个与服务器保持的连接都会给客户端和服务器端造成额外的资源开销，必须引入缓存机制，减少不必要的资源开销。Informer 就是 Kubernetes 开发者们设计的一套缓存机制。</p>
<p>Kubernetes Informer 相关的代码包含在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fclient-go">kubernetes/client-go</a> 仓库中，主要的包有 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fclient-go%2Ftree%2Fmaster%2Ftools%2Fcache">cache</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fclient-go%2Ftree%2Fmaster%2Finformers">informers</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fclient-go%2Ftree%2Fmaster%2Fdynamic">dynamic</a>，其中 informers 和 dynamic 包主要实现 Informer 的使用，Informer 本身逻辑主要聚合在 cache 包中</p>
</blockquote>
<p><img src="https://github.com/kubernetes/sample-controller/blob/master/docs/images/client-go-controller-interaction.jpeg?raw=true" alt=""></p>
<h3 id="client-go使用">client-go使用</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD1</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareClientSet</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Namespaces</span>().<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">Items</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">Name</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">prepareClientSet</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Clientset</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>)

	<span style="color:#a6e22e">config</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">kubeconfig</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//clientset，支持直接请求 api 中各内置资源对象的 restful group 客户端集合
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">clientSet</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">===</span> RUN   TestD1
default
kube-node-lease
kube-public
kube-system
tmp
--- PASS: TestD1 <span style="color:#f92672">(</span>6.93s<span style="color:#f92672">)</span>
PASS
</code></pre></div><h3 id="listwatcher">ListWatcher</h3>
<p>根据上面的架构图，ListWatcher是离数据最近的地方</p>
<ul>
<li>
<p>listWatcher接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Lister is any object that knows how to perform an initial list.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Lister</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// List should return a list type object; the Items field will be extracted, and the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// ResourceVersion field will be used to start the watch in the right place.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">options</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// Watcher is any object that knows how to start a watch on a resource.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Watcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// Watch should begin a watch at the specified version.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">options</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>) (<span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Interface</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ListerWatcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Lister</span>
	<span style="color:#a6e22e">Watcher</span>
}
</code></pre></div></li>
<li>
<p>listWatcher使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD2</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareClientSet</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">RESTClient</span>()
	<span style="color:#a6e22e">resource</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;configmaps&#34;</span>
	<span style="color:#a6e22e">namespace</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;tmp&#34;</span>
	<span style="color:#a6e22e">selector</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fields</span>.<span style="color:#a6e22e">Everything</span>()

	<span style="color:#a6e22e">lw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewListWatchFromClient</span>(<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">selector</span>)
	<span style="color:#a6e22e">list</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lw</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">extractList</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">ExtractList</span>(<span style="color:#a6e22e">list</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Initial list:&#34;</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">extractList</span> {
		<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">item</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ConfigMap</span>)
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
	}

	<span style="color:#a6e22e">accessor</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">ListAccessor</span>(<span style="color:#a6e22e">list</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//watch接口使用的resourceVersion参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">version</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">accessor</span>.<span style="color:#a6e22e">GetResourceVersion</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">version</span>)

	<span style="color:#a6e22e">watch</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lw</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{
		<span style="color:#a6e22e">ResourceVersion</span>: <span style="color:#a6e22e">version</span>,
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">stop</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>)

	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">stop</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Interrupt</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start watching...&#34;</span>)
<span style="color:#a6e22e">loop</span>:
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stop</span>:
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;stop watch&#34;</span>)
			<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">loop</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">ResultChan</span>():
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;watch error&#34;</span>)
				<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">loop</span>
			}
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;obj is not configmap&#34;</span>)
				<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">loop</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		}
	}
}
</code></pre></div></li>
<li>
<p>输出如下</p>
<p><img src="https://pic-frank.oss-cn-beijing.aliyuncs.com/img/202303171458995.gif" alt="Screen Recording 2023-03-17 at 14.30.24"></p>
</li>
<li>
<p>这样就简单的利用lw监听k8s的某个资源，不过存在如下问题</p>
<ul>
<li>如果在监听结果后加上耗时业务逻辑则会阻塞监听协程，因此我们通过缓存进行异步</li>
<li>异常中断的话，没有重新连接的机制</li>
</ul>
</li>
</ul>
<h3 id="reflector">Reflector</h3>
<p>Reflector用来解决上述lw的问题</p>
<ul>
<li>
<p>构造方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NewReflector creates a new Reflector object which will keep the
</span><span style="color:#75715e">// given store up to date with the server&#39;s contents for the given
</span><span style="color:#75715e">// resource. Reflector promises to only put things in the store that
</span><span style="color:#75715e">// have the type of expectedType, unless expectedType is nil. If
</span><span style="color:#75715e">// resyncPeriod is non-zero, then the reflector will periodically
</span><span style="color:#75715e">// consult its ShouldResync function to determine whether to invoke
</span><span style="color:#75715e">// the Store&#39;s Resync operation; `ShouldResync==nil` means always
</span><span style="color:#75715e">// &#34;yes&#34;.  This enables you to use reflectors to periodically process
</span><span style="color:#75715e">// everything as well as incrementally processing the things that
</span><span style="color:#75715e">// change.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewReflector</span>(<span style="color:#a6e22e">lw</span> <span style="color:#a6e22e">ListerWatcher</span>, <span style="color:#a6e22e">expectedType</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">store</span> <span style="color:#a6e22e">Store</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Reflector</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewNamedReflector</span>(<span style="color:#a6e22e">naming</span>.<span style="color:#a6e22e">GetNameFromCallsite</span>(<span style="color:#a6e22e">internalPackages</span><span style="color:#f92672">...</span>), <span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">expectedType</span>, <span style="color:#a6e22e">store</span>, <span style="color:#a6e22e">resyncPeriod</span>)
}
</code></pre></div><p>Reflector的构造方法中除了需要传入lw，还需要传入store和resyncPeriod，这两个参数便是用于解决异步和重试的问题</p>
</li>
<li>
<p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD3</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">// newStore 用于创建一个 cache.Store 对象，作为当前资源状态的对象存储
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">store</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewStore</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>)

	<span style="color:#a6e22e">queue</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewDeltaFIFOWithOptions</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">DeltaFIFOOptions</span>{
		<span style="color:#a6e22e">KnownObjects</span>: <span style="color:#a6e22e">store</span>,
	})

	<span style="color:#75715e">// 第 2 个参数是 expectedType, 用此参数限制进入队列的事件，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 当然在 List 和 Watch 操作时返回的数据就只有一种类型，这个参数只起校验的作用；
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 第 4 个参数是 resyncPeriod，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 这里传了 0，表示从不重新同步（除非连接超时或者中断），
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 如果传了非 0 值，会定期进行全量同步，避免累积和服务器的不一致，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 重新同步过程中会产生 SYNC 类型的事件。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">reflector</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewReflector</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{}, <span style="color:#a6e22e">queue</span>, <span style="color:#ae81ff">0</span>)

	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#75715e">// reflector 开始运行后，队列中就会推入新收到的事件
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">reflector</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#75715e">// 注意处理事件过程中维护好 store 状态，包括 Add, Update, Delete 操作，
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">processObj</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
		<span style="color:#75715e">// 最先收到的事件会被最先处理
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Deltas</span>) {
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Replaced</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Updated</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
					}
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
					}
				}
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Deleted</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
			}
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;not config: %T&#34;</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s: %s\n&#34;</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		}
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start syncing...&#34;</span>)

	<span style="color:#75715e">// 持续运行直到 stopCh 关闭
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Pop</span>(<span style="color:#a6e22e">processObj</span>)
			<span style="color:#75715e">//消费队列
</span><span style="color:#75715e"></span>		}
	}, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)

}
</code></pre></div></li>
</ul>
<p>在以上代码中事件接收后被缓存到队列中，避免了阻塞问题，但对队列的消费仍然是同步的，需要再实现多 worker 才能提高效率。在消费时，我们可以再使用workqueue提高效率。</p>
<h3 id="controller">Controller</h3>
<p>controller将reflector封装在内部，在run的时候，进行了reflector的构建</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD4</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">store</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewStore</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>)

	<span style="color:#a6e22e">queue</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewDeltaFIFOWithOptions</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">DeltaFIFOOptions</span>{
		<span style="color:#a6e22e">KnownObjects</span>: <span style="color:#a6e22e">store</span>,
	})
	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">New</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Queue</span>:         <span style="color:#a6e22e">queue</span>,
		<span style="color:#a6e22e">ListerWatcher</span>: <span style="color:#a6e22e">lw</span>,
		<span style="color:#a6e22e">Process</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Deltas</span>) {
				<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Replaced</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Updated</span>:
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
						<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
							<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
						}
					} <span style="color:#66d9ef">else</span> {
						<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
							<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
						}
					}
				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Deleted</span>:
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
					}
				}
				<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
				<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;not config: %T&#34;</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>)
				}
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s: %s\n&#34;</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
			}
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		},
		<span style="color:#a6e22e">ObjectType</span>:       <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{},
		<span style="color:#a6e22e">FullResyncPeriod</span>: <span style="color:#ae81ff">0</span>,
	})

	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start syncing....&#34;</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>.<span style="color:#a6e22e">Close</span>()
	}()
  <span style="color:#75715e">//create reflector
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewReflector</span>(
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ListerWatcher</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ObjectType</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Queue</span>,
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">FullResyncPeriod</span>,
	)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ShouldResync</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShouldResync</span>
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">WatchListPageSize</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WatchListPageSize</span>
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">clock</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">clock</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WatchErrorHandler</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">watchErrorHandler</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">WatchErrorHandler</span>
	}

	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflector</span> = <span style="color:#a6e22e">r</span>
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">reflectorMutex</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>

	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">StartWithChannel</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Run</span>)

	<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processLoop</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><h3 id="informer">Informer</h3>
<p>informer是controller的进一步升级，帮我们解决了store的维护以及对象的转换</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD5</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
  <span style="color:#75715e">//返回了store，进行消费
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">store</span>, <span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewInformer</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{}, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;created: %s\n&#34;</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		},
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">old</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;updated: %s\n&#34;</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		},
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;deleted: %s\n&#34;</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		},
	})
	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start syncing....&#34;</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
}
</code></pre></div><h3 id="sharedinformer">SharedInformer</h3>
<p>队列由于不能同时被多个消费者消费，SharedInformer就是为了解决这个问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD6</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">informer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewSharedInformer</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{}, <span style="color:#ae81ff">0</span>)

	<span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;created, printing namespace: %s\n&#34;</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Namespace</span>)
		},
	})

	<span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;created, printing name: %s\n&#34;</span>, <span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		},
	})

	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start syncing....&#34;</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>

}
</code></pre></div><p>SharedInformer内部维护了sharedProcessor对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">sharedProcessor</span> <span style="color:#66d9ef">struct</span> {
   <span style="color:#a6e22e">listenersStarted</span> <span style="color:#66d9ef">bool</span>
   <span style="color:#a6e22e">listenersLock</span>    <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
   <span style="color:#a6e22e">listeners</span>        []<span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>
   <span style="color:#a6e22e">syncingListeners</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">processorListener</span>
   <span style="color:#a6e22e">clock</span>            <span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Clock</span>
   <span style="color:#a6e22e">wg</span>               <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Group</span>
}
</code></pre></div><p>在AddEventHandlerWithResyncPeriod方法中，会生成processorListener，添加到sharedProcessor</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">AddEventHandlerWithResyncPeriod</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">ResourceEventHandler</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) (<span style="color:#a6e22e">ResourceEventHandlerRegistration</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">startedLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">stopped</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;handler %v was not added to shared informer because it has stopped already&#34;</span>, <span style="color:#a6e22e">handler</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resyncPeriod</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resyncPeriod</span> &lt; <span style="color:#a6e22e">minimumResyncPeriod</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;resyncPeriod %v is too small. Changing it to the minimum allowed value of %v&#34;</span>, <span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">minimumResyncPeriod</span>)
			<span style="color:#a6e22e">resyncPeriod</span> = <span style="color:#a6e22e">minimumResyncPeriod</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">resyncPeriod</span> &lt; <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">started</span> {
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;resyncPeriod %v is smaller than resyncCheckPeriod %v and the informer has already started. Changing it to %v&#34;</span>, <span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>)
				<span style="color:#a6e22e">resyncPeriod</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#75715e">// if the event handler&#39;s resyncPeriod is smaller than the current resyncCheckPeriod, update
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// resyncCheckPeriod to match resyncPeriod and adjust the resync periods of all the listeners
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// accordingly
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span> = <span style="color:#a6e22e">resyncPeriod</span>
				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">resyncCheckPeriodChanged</span>(<span style="color:#a6e22e">resyncPeriod</span>)
			}
		}
	}

	<span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newProcessListener</span>(<span style="color:#a6e22e">handler</span>, <span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">determineResyncPeriod</span>(<span style="color:#a6e22e">resyncPeriod</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>), <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">Now</span>(), <span style="color:#a6e22e">initialBufferSize</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">HasSynced</span>)

	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">started</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">addListener</span>(<span style="color:#a6e22e">listener</span>), <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// in order to safely join, we have to
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 1. stop sending add/update/delete notifications
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 2. do a list against the store
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 3. send synthetic &#34;Add&#34; events to the new handler
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 4. unblock
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">handle</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">addListener</span>(<span style="color:#a6e22e">listener</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">List</span>() {
		<span style="color:#75715e">// Note that we enqueue these notifications with the lock held
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// and before returning the handle. That means there is never a
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// chance for anyone to call the handle&#39;s HasSynced method in a
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// state when it would falsely return true (i.e., when the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// shared informer is synced but it has not observed an Add
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// with isInitialList being true, nor when the thread
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// processing notifications somehow goes faster than this
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// thread adding them and the counter is temporarily zero).
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">addNotification</span>{<span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">isInInitialList</span>: <span style="color:#66d9ef">true</span>})
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handle</span>, <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>SharedInformer自身实现了ResourceEventHandler接口</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">OnAdd</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#75715e">// Invocation of this function is locked under s.blockDeltas, so it is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// save to distribute the notification
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">cacheMutationDetector</span>.<span style="color:#a6e22e">AddObject</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">addNotification</span>{<span style="color:#a6e22e">newObj</span>: <span style="color:#a6e22e">obj</span>}, <span style="color:#66d9ef">false</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedProcessor</span>) <span style="color:#a6e22e">distribute</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">sync</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listenersLock</span>.<span style="color:#a6e22e">RUnlock</span>()

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">isSyncing</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">listeners</span> {
		<span style="color:#66d9ef">switch</span> {
		<span style="color:#66d9ef">case</span> !<span style="color:#a6e22e">sync</span>:
			<span style="color:#75715e">// non-sync messages are delivered to every listener
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">obj</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">isSyncing</span>:
			<span style="color:#75715e">// sync messages are delivered to every syncing listener
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">obj</span>)
		<span style="color:#66d9ef">default</span>:
			<span style="color:#75715e">// skipping a sync obj for a non-syncing listener
</span><span style="color:#75715e"></span>		}
	}
}
</code></pre></div><p>在run的时候创建controller</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">HasStarted</span>() {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;The sharedIndexInformer has started, run more than once is not allowed&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">fifo</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDeltaFIFOWithOptions</span>(<span style="color:#a6e22e">DeltaFIFOOptions</span>{
		<span style="color:#a6e22e">KnownObjects</span>:          <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>,
		<span style="color:#a6e22e">EmitDeltaTypeReplaced</span>: <span style="color:#66d9ef">true</span>,
	})

	<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Queue</span>:            <span style="color:#a6e22e">fifo</span>,
		<span style="color:#a6e22e">ListerWatcher</span>:    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">listerWatcher</span>,
		<span style="color:#a6e22e">ObjectType</span>:       <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">objectType</span>,
		<span style="color:#a6e22e">FullResyncPeriod</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">resyncCheckPeriod</span>,
		<span style="color:#a6e22e">RetryOnError</span>:     <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ShouldResync</span>:     <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">processor</span>.<span style="color:#a6e22e">shouldResync</span>,

    <span style="color:#75715e">//deal event
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Process</span>:           <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">HandleDeltas</span>,
		<span style="color:#a6e22e">WatchErrorHandler</span>: <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">watchErrorHandler</span>,
	}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sharedIndexInformer</span>) <span style="color:#a6e22e">HandleDeltas</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">blockDeltas</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">deltas</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#a6e22e">Deltas</span>); <span style="color:#a6e22e">ok</span> {
    <span style="color:#75715e">// 将自身传入，调了自身onAdd方法，从而触发processor.distribute，实现多消费者共享
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">processDeltas</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">indexer</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">transform</span>, <span style="color:#a6e22e">deltas</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;object given as Process argument is not Deltas&#34;</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">processDeltas</span>(
	<span style="color:#75715e">// Object which receives event notifications from the given deltas
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">ResourceEventHandler</span>,
	<span style="color:#a6e22e">clientState</span> <span style="color:#a6e22e">Store</span>,
	<span style="color:#a6e22e">deltas</span> <span style="color:#a6e22e">Deltas</span>,
	<span style="color:#a6e22e">isInInitialList</span> <span style="color:#66d9ef">bool</span>,
) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// from oldest to newest
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">deltas</span> {
		<span style="color:#a6e22e">obj</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Object</span>

		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Type</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Sync</span>, <span style="color:#a6e22e">Replaced</span>, <span style="color:#a6e22e">Added</span>, <span style="color:#a6e22e">Updated</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">exists</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">obj</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exists</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">obj</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">obj</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">obj</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
				}
				<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnAdd</span>(<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">isInInitialList</span>)
			}
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Deleted</span>:
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientState</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">obj</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
			}
			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnDelete</span>(<span style="color:#a6e22e">obj</span>)
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>

</code></pre></div><h3 id="indexer">Indexer</h3>
<p>最一开始的store，在informer的每次触发后，都会保存最新的数据在缓存中。cache提供了indexer来为这份缓存创建索引。默认情况下提供的是MetaNamespaceIndexFunc，即通过namespace创建索引</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD7</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {

	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">indexer</span>, <span style="color:#a6e22e">informer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewIndexerInformer</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{}, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{},
		<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NamespaceIndex</span>: <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceIndexFunc</span>})

	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">defer</span> close(<span style="color:#a6e22e">stopCh</span>)

	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Start syncing....&#34;</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">stopCh</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">WaitForCacheSync</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">informer</span>.<span style="color:#a6e22e">HasSynced</span>) {
		panic(<span style="color:#e6db74">&#34;timed out waiting for caches to sync&#34;</span>)
	}

	<span style="color:#75715e">// 获取 cache.NamespaceIndex 索引下，索引值为 &#34;tmp&#34; 中的所有键
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">keys</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">IndexKeys</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NamespaceIndex</span>, <span style="color:#e6db74">&#34;tmp&#34;</span>)

	<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">exist</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">indexer</span>.<span style="color:#a6e22e">GetByKey</span>(<span style="color:#e6db74">&#34;tmp/hello4&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">exist</span> {
		<span style="color:#a6e22e">configMap</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">configMap</span>.<span style="color:#a6e22e">Name</span>)
		}
	}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">keys</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span>)
	}

}
</code></pre></div><p>我们可以自定义索引，例如根据labels的值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//index by label key
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MetaLabelsIndexFunc</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) ([]<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">meta</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">Accessor</span>(<span style="color:#a6e22e">obj</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;&#34;</span>}, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;object has no meta: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">labels</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">GetLabels</span>()
	<span style="color:#a6e22e">keys</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">labels</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">labels</span> {
		<span style="color:#a6e22e">keys</span> = append(<span style="color:#a6e22e">keys</span>, <span style="color:#a6e22e">k</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">keys</span>, <span style="color:#66d9ef">nil</span>
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestD7</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {

	<span style="color:#a6e22e">lw</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">prepareListWatcher</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">indexer</span>, <span style="color:#a6e22e">informer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NewIndexerInformer</span>(<span style="color:#a6e22e">lw</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ConfigMap</span>{}, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{},
		<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">Indexers</span>{
			<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">NamespaceIndex</span>: <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceIndexFunc</span>,
			<span style="color:#e6db74">&#34;labels&#34;</span>:             <span style="color:#a6e22e">MetaLabelsIndexFunc</span>,
		})
  <span style="color:#f92672">......</span>
}
</code></pre></div><h3 id="sharedindexinformer">SharedIndexInformer</h3>
<p>SharedIndexInformer 是封装程度最高的一个，也是大部分情况下我们会选择使用的一个，同时也是 informers 包中 SharedInformerFactory 给所有内置资源创建 Informer 时所使用的方法。</p>
<h3 id="informerfactory">InformerFactory</h3>
<p>Informer的工程模式</p>
<p>创建每一个informer，我们都需要准备lw以及indexer，go-client包中为我们准备了所有内置resource的工厂构建方法，放在SharedInformerFactory中。所有informer都会被缓存，重复调用都是同一个实例。</p>
<ul>
<li>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">configMapsInformer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">ConfigMaps</span>().<span style="color:#a6e22e">Informer</span>()
</code></pre></div><p>默认情况下factory模式下的informer是NewSharedIndexInformer，并且会生成namespace的indexer</p>
</li>
</ul>
<h3 id="workerqueue">Workerqueue</h3>
<p>从上面的图可以看到，在informer发出事件后，controller使用了一个workerqueue进行异步消费，解决了之前提到的消费同步效率不高的问题。</p>
<p>client-go提供了workqueue包，用于构建workerqueue</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">rateLimiter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">DefaultControllerRateLimiter</span>()
<span style="color:#a6e22e">queue</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">NewRateLimitingQueue</span>(<span style="color:#a6e22e">rateLimiter</span>)


<span style="color:#75715e">// 默认名情况下提供了2个限流，令牌桶是为了流量并发控制，以及失败限制
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultControllerRateLimiter</span>() <span style="color:#a6e22e">RateLimiter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewMaxOfRateLimiter</span>(
		<span style="color:#a6e22e">NewItemExponentialFailureRateLimiter</span>(<span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>, <span style="color:#ae81ff">1000</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>),
		<span style="color:#75715e">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)
</span><span style="color:#75715e"></span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">BucketRateLimiter</span>{<span style="color:#a6e22e">Limiter</span>: <span style="color:#a6e22e">rate</span>.<span style="color:#a6e22e">NewLimiter</span>(<span style="color:#a6e22e">rate</span>.<span style="color:#a6e22e">Limit</span>(<span style="color:#ae81ff">10</span>), <span style="color:#ae81ff">100</span>)},
	)
}

<span style="color:#75715e">// 失败后每次执行时间变成baseDelay*2^n,意味着如果不主动放弃这个key，队列会不断重试
</span><span style="color:#75715e">// ItemExponentialFailureRateLimiter does a simple baseDelay*2^&lt;num-failures&gt; limit
</span><span style="color:#75715e">// dealing with max failures and expiration are up to the caller
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ItemExponentialFailureRateLimiter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">failuresLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#a6e22e">failures</span>     <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">interface</span>{}]<span style="color:#66d9ef">int</span>

	<span style="color:#a6e22e">baseDelay</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#a6e22e">maxDelay</span>  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
}
</code></pre></div><ul>
<li>
<p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//在informer接收到事件
</span><span style="color:#75715e"></span><span style="color:#a6e22e">configMapInformer</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">MetaNamespaceKeyFunc</span>(<span style="color:#a6e22e">new</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#75715e">// 只简单地把 key 放到工作队列中
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;[%s] received&#34;</span>, <span style="color:#a6e22e">key</span>)
				<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">key</span>)
			}
		},
	})
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">runWorker</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	}

	<span style="color:#75715e">// 等待 stopCh 关闭
</span><span style="color:#75715e"></span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SlothController</span>) <span style="color:#a6e22e">runWorker</span>() {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processNextItem</span>() {
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SlothController</span>) <span style="color:#a6e22e">processNextItem</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#75715e">// 阻塞住，等待新任务中...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">shutdown</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Get</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shutdown</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e">// 队列已进入退出状态，不要继续处理
</span><span style="color:#75715e"></span>	}

	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Done</span>(<span style="color:#a6e22e">key</span>)

	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processItem</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">handleErr</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">result</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SlothController</span>) <span style="color:#a6e22e">processItem</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">nap</span>)
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;[%s] processed.&#34;</span>, <span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// handleErr 用于检查任务处理结果，在必要的时候重试
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SlothController</span>) <span style="color:#a6e22e">handleErr</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">result</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// 每次执行成功后清空重试记录。
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">NumRequeues</span>(<span style="color:#a6e22e">key</span>) &lt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">maxRetries</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;error processing %s: %v , retry %v&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">NumRequeues</span>(<span style="color:#a6e22e">key</span>))
		<span style="color:#75715e">// 执行失败，重试
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">AddRateLimited</span>(<span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#75715e">// 重试次数过多，日志记录错误
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#75715e">// runtime.HandleError 是 Kubernetes 官方提供的错误响应方法，
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 提供一个错误响应的统一入口。
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;max retries exceeded, &#34;</span><span style="color:#f92672">+</span>
		<span style="color:#e6db74">&#34;dropping item %s out of the queue: %v&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">result</span>))
}
</code></pre></div></li>
</ul>
<h3 id="crd-informer">Crd Informer</h3>
<p>kubernetes官方提供了所有内置资源的informer，那crd资源呢？</p>
<h2 id="最佳实战-sample-controller">最佳实战 Sample Controller</h2>
<p>kubernetes官方提供了<a href="https://github.com/kubernetes/sample-controller">SampleController</a>的自定义controller例子，通过实现crd的controller来让开发者更熟悉informer。</p>
<h3 id="crd">Crd</h3>
<p>参考官方<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resources</a></p>
<h3 id="code-generator">Code-generator</h3>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes%2Fcode-generator">code-generator</a> 是 Kubernetes 的代码生成套件，提供了许多代码生成命令，用于生成自定义资源相关的代码，包括我们关心的 Informer。</p>
<p>实际上所有 Kubernetes 内置资源的 Lister, Informer, SharedInformerFactory，都是使用 code-generator 生成的</p>
</blockquote>
<p>code generator包含了client-gen, lister-gen,informer-gen 等生成工具，除此之外还提供了generate-groups.sh脚本，方便我们一次生成所有代码。</p>
<p>SampleController的hack文件夹下提供了几个脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#hack 文件</span>
.
├── boilerplate.go.txt <span style="color:#75715e">#头部版权文件</span>
├── custom-boilerplate.go.txt <span style="color:#75715e">#自定义头部版权文件</span>
├── tools.go
├── update-codegen.sh <span style="color:#75715e">#脚本生成</span>
└── verify-codegen.sh 

</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">set -o errexit
set -o nounset
set -o pipefail

SCRIPT_ROOT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BASH_SOURCE[0]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>/..
<span style="color:#75715e">#调用code-generator</span>
CODEGEN_PKG<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CODEGEN_PKG<span style="color:#66d9ef">:-$(</span>cd <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SCRIPT_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; ls -d -1 ./vendor/k8s.io/code-generator 2&gt;/dev/null <span style="color:#f92672">||</span> echo ../code-generator<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span>

<span style="color:#75715e"># generate the code with:</span>
<span style="color:#75715e"># --output-base    because this script should also be able to run inside the vendor dir of</span>
<span style="color:#75715e">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
<span style="color:#75715e">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>
bash <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CODEGEN_PKG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/generate-groups.sh <span style="color:#e6db74">&#34;deepcopy,client,informer,lister&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sample-controller/pkg/generated sample-controller/pkg/apis <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  samplecontroller:v1alpha1 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output-base <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BASH_SOURCE[0]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">/../..&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --go-header-file <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SCRIPT_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/hack/boilerplate.go.txt

<span style="color:#75715e"># To use your own boilerplate text append:</span>
<span style="color:#75715e">#   --go-header-file &#34;${SCRIPT_ROOT}&#34;/hack/custom-boilerplate.go.txt</span>
</code></pre></div><p>当资源类型有变更时即时执行update-codegen.sh进行更新，也可以使用verify-codegen.sh</p>
<h3 id="samplecontroller执行">SampleController执行</h3>
<ul>
<li>
<p>创建crd</p>
<p>仓库中为我们提供了artifact，使用crd.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">foos.samplecontroller.k8s.io</span>
  <span style="color:#75715e"># for more information on the below annotation, please see</span>
  <span style="color:#75715e"># https://github.com/kubernetes/enhancements/blob/master/keps/sig-api-machinery/2337-k8s.io-group-protection/README.md</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">&#34;api-approved.kubernetes.io&#34;: </span><span style="color:#e6db74">&#34;unapproved, experimental-only; please get an approval from Kubernetes API reviewers if you&#39;re trying to develop a CRD in the *.k8s.io or *.kubernetes.io groups&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">samplecontroller.k8s.io</span>
  <span style="color:#f92672">versions</span>:
    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
      <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">schema</span>:
        <span style="color:#75715e"># schema used for validation</span>
        <span style="color:#f92672">openAPIV3Schema</span>:
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
          <span style="color:#f92672">properties</span>:
            <span style="color:#f92672">spec</span>:
              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
              <span style="color:#f92672">properties</span>:
                <span style="color:#f92672">deploymentName</span>:
                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
                <span style="color:#f92672">replicas</span>:
                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
                  <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">1</span>
                  <span style="color:#f92672">maximum</span>: <span style="color:#ae81ff">10</span>
            <span style="color:#f92672">status</span>:
              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
              <span style="color:#f92672">properties</span>:
                <span style="color:#f92672">availableReplicas</span>:
                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
  <span style="color:#f92672">names</span>:
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Foo</span>
    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">foos</span>
  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>

</code></pre></div></li>
<li>
<p>执行</p>
<p><img src="https://pic-frank.oss-cn-beijing.aliyuncs.com/img/202303201045174.gif" alt="Screen Recording 2023-03-20 at 10.36.26"></p>
</li>
</ul>
<p>​		<em><strong>这里触发很多次的原因是我本地已经执行过，没有下载镜像的环境，触发update事件很快。</strong></em></p>
<ul>
<li>
<p>核心源码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">InitFlags</span>(<span style="color:#66d9ef">nil</span>)
	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()

	<span style="color:#75715e">// set up signals so we handle the first shutdown signal gracefully
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">signals</span>.<span style="color:#a6e22e">SetupSignalHandler</span>()

	<span style="color:#a6e22e">cfg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#a6e22e">masterURL</span>, <span style="color:#a6e22e">kubeconfig</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error building kubeconfig: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}

	<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error building kubernetes clientset: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}

	<span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">cfg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error building example clientset: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}

  <span style="color:#75715e">//构建informerFactory
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kubeInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubeinformers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)
	<span style="color:#a6e22e">exampleInformerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">exampleClient</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)

  <span style="color:#75715e">//创建controller
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewController</span>(<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">exampleClient</span>,
		<span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Apps</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Deployments</span>(),
		<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Samplecontroller</span>().<span style="color:#a6e22e">V1alpha1</span>().<span style="color:#a6e22e">Foos</span>())

	<span style="color:#75715e">// notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(stopCh)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Start method is non-blocking and runs all registered informers in a dedicated goroutine.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kubeInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)
	<span style="color:#a6e22e">exampleInformerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">stopCh</span>)

  <span style="color:#75715e">//运行2个worker
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">stopCh</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error running controller: %s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewController</span>(
	<span style="color:#a6e22e">kubeclientset</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">Interface</span>,
	<span style="color:#a6e22e">sampleclientset</span> <span style="color:#a6e22e">clientset</span>.<span style="color:#a6e22e">Interface</span>,
	<span style="color:#a6e22e">deploymentInformer</span> <span style="color:#a6e22e">appsinformers</span>.<span style="color:#a6e22e">DeploymentInformer</span>,
	<span style="color:#a6e22e">fooInformer</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">FooInformer</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span> {

	<span style="color:#75715e">// Create event broadcaster
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Add sample-controller types to the default Kubernetes Scheme so Events can be
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// logged for sample-controller types.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">Must</span>(<span style="color:#a6e22e">samplescheme</span>.<span style="color:#a6e22e">AddToScheme</span>(<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">Scheme</span>))
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Creating event broadcaster&#34;</span>)
	<span style="color:#a6e22e">eventBroadcaster</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">NewBroadcaster</span>()
	<span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">StartStructuredLogging</span>(<span style="color:#ae81ff">0</span>)
	<span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">StartRecordingToSink</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">typedcorev1</span>.<span style="color:#a6e22e">EventSinkImpl</span>{<span style="color:#a6e22e">Interface</span>: <span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Events</span>(<span style="color:#e6db74">&#34;&#34;</span>)})
	<span style="color:#a6e22e">recorder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">eventBroadcaster</span>.<span style="color:#a6e22e">NewRecorder</span>(<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">Scheme</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventSource</span>{<span style="color:#a6e22e">Component</span>: <span style="color:#a6e22e">controllerAgentName</span>})

	<span style="color:#a6e22e">controller</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Controller</span>{
		<span style="color:#a6e22e">kubeclientset</span>:     <span style="color:#a6e22e">kubeclientset</span>,
		<span style="color:#a6e22e">sampleclientset</span>:   <span style="color:#a6e22e">sampleclientset</span>,
		<span style="color:#a6e22e">deploymentsLister</span>: <span style="color:#a6e22e">deploymentInformer</span>.<span style="color:#a6e22e">Lister</span>(),
		<span style="color:#a6e22e">deploymentsSynced</span>: <span style="color:#a6e22e">deploymentInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>,
		<span style="color:#a6e22e">foosLister</span>:        <span style="color:#a6e22e">fooInformer</span>.<span style="color:#a6e22e">Lister</span>(),
		<span style="color:#a6e22e">foosSynced</span>:        <span style="color:#a6e22e">fooInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>,
		<span style="color:#a6e22e">workqueue</span>:         <span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">NewNamedRateLimitingQueue</span>(<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">DefaultControllerRateLimiter</span>(), <span style="color:#e6db74">&#34;Foos&#34;</span>),
		<span style="color:#a6e22e">recorder</span>:          <span style="color:#a6e22e">recorder</span>,
	}

	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Setting up event handlers&#34;</span>)
	<span style="color:#75715e">// Set up an event handler for when Foo resources change
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// add和update事件都入队
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fooInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">enqueueFoo</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">enqueueFoo</span>(<span style="color:#a6e22e">new</span>)
		},
	})
	<span style="color:#75715e">// Set up an event handler for when Deployment resources change. This
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// handler will lookup the owner of the given Deployment, and if it is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// owned by a Foo resource then the handler will enqueue that Foo resource for
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// processing. This way, we don&#39;t need to implement custom logic for
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// handling Deployment resources. More info on this pattern:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//还监听了deployment的event，用于更新foo的status
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">deploymentInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>,
		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">old</span>, <span style="color:#a6e22e">new</span> <span style="color:#66d9ef">interface</span>{}) {
			<span style="color:#a6e22e">newDepl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">new</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>)
			<span style="color:#a6e22e">oldDepl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">old</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">newDepl</span>.<span style="color:#a6e22e">ResourceVersion</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">oldDepl</span>.<span style="color:#a6e22e">ResourceVersion</span> {
				<span style="color:#75715e">// Periodic resync will send update events for all known Deployments.
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// Two different versions of the same Deployment will always have different RVs.
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>(<span style="color:#a6e22e">new</span>)
		},
		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">handleObject</span>,
	})

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//最终的逻辑处理,与之前描述的几乎一样
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">workers</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleCrash</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">ShutDown</span>()

	<span style="color:#75715e">// Start the informer factories to begin populating the informer caches
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Starting Foo controller&#34;</span>)

	<span style="color:#75715e">// Wait for the caches to be synced before starting workers
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Waiting for informer caches to sync&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">WaitForCacheSync</span>(<span style="color:#a6e22e">stopCh</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">deploymentsSynced</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">foosSynced</span>); !<span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to wait for caches to sync&#34;</span>)
	}

	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Starting workers&#34;</span>)
	<span style="color:#75715e">// Launch two workers to process Foo resources
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">workers</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">runWorker</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">stopCh</span>)
	}

	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Started workers&#34;</span>)
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>
	<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Shutting down workers&#34;</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">runWorker</span>() {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">processNextWorkItem</span>() {
	}
}

<span style="color:#75715e">// processNextWorkItem will read a single work item off the workqueue and
</span><span style="color:#75715e">// attempt to process it, by calling the syncHandler.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">processNextWorkItem</span>() <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">obj</span>, <span style="color:#a6e22e">shutdown</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Get</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">shutdown</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}

	<span style="color:#75715e">// We wrap this block in a func so we can defer c.workqueue.Done.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
		<span style="color:#75715e">// We call Done here so the workqueue knows we have finished
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// processing this item. We also must remember to call Forget if we
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// do not want this work item being re-queued. For example, we do
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// not call Forget if a transient error occurs, instead the item is
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// put back on the workqueue and attempted again after a back-off
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// period.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Done</span>(<span style="color:#a6e22e">obj</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ok</span> <span style="color:#66d9ef">bool</span>
		<span style="color:#75715e">// We expect strings to come off the workqueue. These are of the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// form namespace/name. We do this as the delayed nature of the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// workqueue means the items in the informer cache may actually be
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// more up to date that when the item was initially put onto the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// workqueue.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">obj</span>.(<span style="color:#66d9ef">string</span>); !<span style="color:#a6e22e">ok</span> {
			<span style="color:#75715e">// As the item in the workqueue is actually invalid, we call
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// Forget here else we&#39;d go into a loop of attempting to
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// process a work item that is invalid.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">obj</span>)
			<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;expected string in workqueue but got %#v&#34;</span>, <span style="color:#a6e22e">obj</span>))
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#75715e">// Run the syncHandler, passing it the namespace/name string of the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Foo resource to be synced.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">syncHandler</span>(<span style="color:#a6e22e">key</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#75715e">// Put the item back on the workqueue to handle any transient errors.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">AddRateLimited</span>(<span style="color:#a6e22e">key</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;error syncing &#39;%s&#39;: %s, requeuing&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		}
		<span style="color:#75715e">// Finally, if no error occurs we Forget this item so it does not
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// get queued again until another change happens.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">workqueue</span>.<span style="color:#a6e22e">Forget</span>(<span style="color:#a6e22e">obj</span>)
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Successfully synced &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}(<span style="color:#a6e22e">obj</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}

<span style="color:#75715e">// syncHandler compares the actual state with the desired, and attempts to
</span><span style="color:#75715e">// converge the two. It then updates the Status block of the Foo resource
</span><span style="color:#75715e">// with the current status of the resource.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Controller</span>) <span style="color:#a6e22e">syncHandler</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// Convert the namespace/name string into a distinct namespace and name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">namespace</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">SplitMetaNamespaceKey</span>(<span style="color:#a6e22e">key</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid resource key: %s&#34;</span>, <span style="color:#a6e22e">key</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// Get the Foo resource with this namespace/name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">foosLister</span>.<span style="color:#a6e22e">Foos</span>(<span style="color:#a6e22e">namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// The Foo resource may no longer exist, in which case we stop
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// processing.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
			<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;foo &#39;%s&#39; in work queue no longer exists&#34;</span>, <span style="color:#a6e22e">key</span>))
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">deploymentName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">DeploymentName</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">deploymentName</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#75715e">// We choose to absorb the error here as the worker would requeue the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// resource otherwise. Instead, the next time the resource is updated
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// the resource will be queued again.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">utilruntime</span>.<span style="color:#a6e22e">HandleError</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s: deployment name must be specified&#34;</span>, <span style="color:#a6e22e">key</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// Get the deployment with the name specified in Foo.spec
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// 检查deployment是否创建完成
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">deploymentsLister</span>.<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">deploymentName</span>)
	<span style="color:#75715e">// If the resource doesn&#39;t exist, we&#39;ll create it
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
		<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">newDeployment</span>(<span style="color:#a6e22e">foo</span>), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{})
	}

	<span style="color:#75715e">// If an error occurs during Get/Create, we&#39;ll requeue the item so we can
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// attempt processing again later. This could have been caused by a
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// temporary network failure, or any other transient reason.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// If the Deployment is not controlled by this Foo resource, we should log
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// a warning to the event recorder and return error msg.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">IsControlledBy</span>(<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">foo</span>) {
		<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">MessageResourceExists</span>, <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recorder</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#a6e22e">ErrResourceExists</span>, <span style="color:#a6e22e">msg</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#a6e22e">msg</span>)
	}

	<span style="color:#75715e">// If this number of the replicas on the Foo resource is specified, and the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// number does not equal the current desired replicas on the Deployment, we
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// should update the Deployment resource.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Foo %s replicas: %d, deployment replicas: %d&#34;</span>, <span style="color:#a6e22e">name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>)
		<span style="color:#a6e22e">deployment</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">kubeclientset</span>.<span style="color:#a6e22e">AppsV1</span>().<span style="color:#a6e22e">Deployments</span>(<span style="color:#a6e22e">foo</span>.<span style="color:#a6e22e">Namespace</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">newDeployment</span>(<span style="color:#a6e22e">foo</span>), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">UpdateOptions</span>{})
	}

	<span style="color:#75715e">// If an error occurs during Update, we&#39;ll requeue the item so we can
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// attempt processing again later. This could have been caused by a
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// temporary network failure, or any other transient reason.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// Finally, we update the status block of the Foo resource to reflect the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// current state of the world
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">updateFooStatus</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">deployment</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

  <span style="color:#75715e">//事件记录
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recorder</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">foo</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#a6e22e">SuccessSynced</span>, <span style="color:#a6e22e">MessageResourceSynced</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>最后的事件记录，就是我们平时在describe命令里看到的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">Name</span>:         <span style="color:#ae81ff">example-foo</span>
<span style="color:#f92672">Namespace</span>:    <span style="color:#ae81ff">default</span>
<span style="color:#f92672">Labels</span>:       <span style="color:#ae81ff">&lt;none&gt;</span>
<span style="color:#f92672">Annotations</span>:  <span style="color:#ae81ff">&lt;none&gt;</span>
<span style="color:#f92672">API Version</span>:  <span style="color:#ae81ff">samplecontroller.k8s.io/v1alpha1</span>
<span style="color:#f92672">Kind</span>:         <span style="color:#ae81ff">Foo</span>
<span style="color:#f92672">Metadata</span>:
  <span style="color:#f92672">Creation Timestamp</span>:  <span style="color:#e6db74">2023-03-20T02:36:35Z</span>
  <span style="color:#f92672">Generation</span>:          <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">Managed Fields</span>:
    <span style="color:#f92672">API Version</span>:  <span style="color:#ae81ff">samplecontroller.k8s.io/v1alpha1</span>
    <span style="color:#f92672">Fields Type</span>:  <span style="color:#ae81ff">FieldsV1</span>
    <span style="color:#f92672">fieldsV1</span>:
      <span style="color:#f92672">f:status</span>:
        <span style="color:#f92672">.</span>:
        <span style="color:#f92672">f:availableReplicas</span>:
    <span style="color:#f92672">Manager</span>:      <span style="color:#ae81ff">___go_build_sample_controller</span>
    <span style="color:#f92672">Operation</span>:    <span style="color:#ae81ff">Update</span>
    <span style="color:#f92672">Subresource</span>:  <span style="color:#ae81ff">status</span>
    <span style="color:#f92672">Time</span>:         <span style="color:#e6db74">2023-03-20T02:36:35Z</span>
    <span style="color:#f92672">API Version</span>:  <span style="color:#ae81ff">samplecontroller.k8s.io/v1alpha1</span>
    <span style="color:#f92672">Fields Type</span>:  <span style="color:#ae81ff">FieldsV1</span>
    <span style="color:#f92672">fieldsV1</span>:
      <span style="color:#f92672">f:metadata</span>:
        <span style="color:#f92672">f:annotations</span>:
          <span style="color:#f92672">.</span>:
          <span style="color:#f92672">f:kubectl.kubernetes.io/last-applied-configuration</span>:
      <span style="color:#f92672">f:spec</span>:
        <span style="color:#f92672">.</span>:
        <span style="color:#f92672">f:deploymentName</span>:
        <span style="color:#f92672">f:replicas</span>:
    <span style="color:#f92672">Manager</span>:         <span style="color:#ae81ff">kubectl-client-side-apply</span>
    <span style="color:#f92672">Operation</span>:       <span style="color:#ae81ff">Update</span>
    <span style="color:#f92672">Time</span>:            <span style="color:#e6db74">2023-03-20T02:36:35Z</span>
  <span style="color:#f92672">Resource Version</span>:  <span style="color:#ae81ff">43500</span>
  <span style="color:#f92672">UID</span>:               <span style="color:#ae81ff">fa2b93fb-5379-4a83-8676-ed78ea470680</span>
<span style="color:#f92672">Spec</span>:
  <span style="color:#f92672">Deployment Name</span>:  <span style="color:#ae81ff">example-foo</span>
  <span style="color:#f92672">Replicas</span>:         <span style="color:#ae81ff">1</span>
<span style="color:#f92672">Status</span>:
  <span style="color:#f92672">Available Replicas</span>:  <span style="color:#ae81ff">1</span>
<span style="color:#f92672">Events</span>:
  <span style="color:#ae81ff">Type    Reason  Age                From               Message</span>
  ----    ------  ----               ----               -------
  <span style="color:#ae81ff">Normal  Synced  16m (x7 over 16m)  sample-controller  Foo synced successfully</span>
</code></pre></div></li>
</ul>
<h3 id="应用中心查询应用状态">应用中心查询应用状态</h3>
<p>对于ArcherkKE应用中心需要实时查看各种资源以及Crd资源状态，只需要用Informer监听就可以了。</p>
<blockquote>
<p>动态增加informer，官方问我们准备了dynamic包，使用起来几乎与informer无异</p>
<p><a href="https://juejin.cn/post/6965476212420378632">参考</a></p>
</blockquote>
<h2 id="kubebuilder">Kubebuilder</h2>
<p>从上述的内容我们了解了一个controller的开发过程，但是好像还是很麻烦，例如crd编写，代码生成，最后controller如何打包发布。<a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>就是进一步帮助k8s developer开发controller(operator)的手脚架工具</p>
<h3 id="让cm变成云原生cm">让CM变成云原生CM</h3>
<h4 id="构建cr">构建CR</h4>
<p>我们来创建一个 HUAYUN CloudManager应用，假设内部的CM应用只有frontend和Identity，设计CR如下</p>
<blockquote>
<p>cm 配置文件太多，会影响到deployment的ready副本数，这里front 就用nginx，identity 用busybox代替</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cloudmanagercontroller.huayun.com/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CloudManager</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudmanager-sample</span>
<span style="color:#f92672">spec</span>:
	<span style="color:#f92672">front</span>:
		<span style="color:#f92672">deployment</span>:
			<span style="color:#75715e">#image: harbor.archeros.cn/dev/application-front:archerke3.0_aarch64_0306</span>
			<span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.20</span>
			<span style="color:#f92672">name</span>: <span style="color:#ae81ff">ake-front</span>
	<span style="color:#f92672">identity</span>:
		<span style="color:#f92672">deployment</span>:
			<span style="color:#75715e">#image: harbor.archeros.cn/dev/identity:archerke3.0_aarch64_0306</span>
			<span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.32.1</span>
			<span style="color:#f92672">name</span>: <span style="color:#ae81ff">cm-identity</span>
	<span style="color:#f92672">db</span>:
		<span style="color:#f92672">statefulSet</span>:
			<span style="color:#f92672">image</span>: <span style="color:#ae81ff">harbor.archeros.cn/library/mariadb:v10.3.35_aarch64_health</span>
			<span style="color:#f92672">name</span>: <span style="color:#ae81ff">cm-db</span>
			<span style="color:#f92672">storage</span>:
    		<span style="color:#f92672">class</span>: <span style="color:#ae81ff">local-path</span>
    		<span style="color:#f92672">accessModes</span>: <span style="color:#ae81ff">ReadWriteOnce</span>
    		<span style="color:#f92672">size</span>: <span style="color:#ae81ff">20Gi</span>
    <span style="color:#f92672">rootPass</span>: <span style="color:#e6db74">&#39;123456&#39;</span>
</code></pre></div><h4 id="创建operator-project">创建operator project</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> zero@ZerodeMacBook-Pro cm-operator % go mod init huayun.com/cm-operator
go: creating new go.mod: module huayun.com/cm-operator
<span style="color:#75715e">## 使用kubebuilder init命令，指令domain为 huayun.com</span>
<span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> zero@ZerodeMacBook-Pro cm-operator % kubebuilder init --domain huayun.com
WARN<span style="color:#f92672">[</span>0000<span style="color:#f92672">]</span> the platform of this environment <span style="color:#f92672">(</span>darwin/arm64<span style="color:#f92672">)</span> is not suppported by kustomize v3 <span style="color:#f92672">(</span>v3.8.7<span style="color:#f92672">)</span> which is used in this scaffold. You will be unable to download a binary <span style="color:#66d9ef">for</span> the kustomize version supported and used by this plugin. The currently supported platforms are: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;linux/amd64&#34;</span> <span style="color:#e6db74">&#34;linux/arm64&#34;</span> <span style="color:#e6db74">&#34;darwin/amd64&#34;</span><span style="color:#f92672">]</span>
Writing kustomize manifests <span style="color:#66d9ef">for</span> you to edit...
Writing scaffold <span style="color:#66d9ef">for</span> you to edit...
Get controller runtime:
$ go get sigs.k8s.io/controller-runtime@v0.14.1
go: downloading sigs.k8s.io/controller-runtime v0.14.1
go: downloading k8s.io/apimachinery v0.26.0
go: downloading github.com/prometheus/client_golang v1.14.0
go: downloading k8s.io/client-go v0.26.0
go: downloading k8s.io/utils v0.0.0-20221128185143-99ec85e7a448
go: downloading k8s.io/api v0.26.0
go: downloading k8s.io/component-base v0.26.0
go: downloading golang.org/x/time v0.3.0
go: downloading k8s.io/apiextensions-apiserver v0.26.0
go: downloading golang.org/x/sys v0.3.0
go: downloading github.com/matttproud/golang_protobuf_extensions v1.0.2
go: downloading golang.org/x/net v0.3.1-0.20221206200815-1e63c2f08a10
go: downloading golang.org/x/term v0.3.0
go: downloading github.com/fsnotify/fsnotify v1.6.0
go: downloading golang.org/x/text v0.5.0
Update dependencies:
$ go mod tidy
go: downloading go.uber.org/zap v1.24.0
go: downloading github.com/onsi/ginkgo/v2 v2.6.0
go: downloading github.com/onsi/gomega v1.24.1
go: downloading go.uber.org/goleak v1.2.0
Next: define a resource with:
$ kubebuilder create api
<span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> zero@ZerodeMacBook-Pro cm-operator %
</code></pre></div><p>生成目录如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">├── Dockerfile
├── Makefile
├── PROJECT
├── README.md
├── config
│   ├── crd
│   ├── default
│   ├── manager
│   ├── prometheus
│   └── rbac
├── go.mod
├── go.sum
├── hack
│   └── boilerplate.go.txt
└── main.go <span style="color:#75715e">##程序入口</span>
</code></pre></div><h4 id="创建api-和-controller">创建api 和 controller</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">(<span style="color:#a6e22e">base</span>) <span style="color:#a6e22e">zero</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">ZerodeMacBook</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Pro</span> <span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">kubebuilder</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">api</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">cloudmanagercontroller</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">version</span> <span style="color:#a6e22e">v1</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">kind</span> <span style="color:#a6e22e">CloudManager</span>
<span style="color:#a6e22e">Create</span> <span style="color:#a6e22e">Resource</span> [<span style="color:#a6e22e">y</span><span style="color:#f92672">/</span><span style="color:#a6e22e">n</span>]
<span style="color:#a6e22e">y</span>
<span style="color:#a6e22e">Create</span> <span style="color:#a6e22e">Controller</span> [<span style="color:#a6e22e">y</span><span style="color:#f92672">/</span><span style="color:#a6e22e">n</span>]
<span style="color:#a6e22e">y</span>
<span style="color:#a6e22e">Writing</span> <span style="color:#a6e22e">kustomize</span> <span style="color:#a6e22e">manifests</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">edit</span><span style="color:#f92672">...</span>
<span style="color:#a6e22e">Writing</span> <span style="color:#a6e22e">scaffold</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">edit</span><span style="color:#f92672">...</span>
<span style="color:#a6e22e">api</span><span style="color:#f92672">/</span><span style="color:#a6e22e">v1</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cloudmanager_types</span>.<span style="color:#66d9ef">go</span>
<span style="color:#a6e22e">controllers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cloudmanager_controller</span>.<span style="color:#66d9ef">go</span>
<span style="color:#a6e22e">Update</span> <span style="color:#a6e22e">dependencies</span>:
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">mod</span> <span style="color:#a6e22e">tidy</span>
<span style="color:#a6e22e">Running</span> <span style="color:#a6e22e">make</span>:
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">make</span> <span style="color:#a6e22e">generate</span>
<span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zero</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Projects</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Personal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span>
<span style="color:#a6e22e">test</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">s</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zero</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Projects</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Personal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gen</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zero</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Projects</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Personal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gen</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">version</span> | <span style="color:#a6e22e">grep</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">q</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.11.1</span> <span style="color:#f92672">||</span> \
	<span style="color:#a6e22e">GOBIN</span>=<span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zero</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Projects</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Personal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">install</span> <span style="color:#a6e22e">sigs</span>.<span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tools</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cmd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gen</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.11.1</span>
<span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">downloading</span> <span style="color:#a6e22e">sigs</span>.<span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tools</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.11.1</span>
<span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">downloading</span> <span style="color:#a6e22e">golang</span>.<span style="color:#a6e22e">org</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">/</span><span style="color:#a6e22e">tools</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.4.0</span>
<span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">downloading</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">gobuffalo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">flect</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.3.0</span>
<span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">downloading</span> <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">utils</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.0.0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20221107191617</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">a15be271d1d</span>
<span style="color:#66d9ef">go</span>: <span style="color:#a6e22e">downloading</span> <span style="color:#a6e22e">golang</span>.<span style="color:#a6e22e">org</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x</span><span style="color:#f92672">/</span><span style="color:#a6e22e">net</span> <span style="color:#a6e22e">v0</span><span style="color:#ae81ff">.4.0</span>
<span style="color:#f92672">/</span><span style="color:#a6e22e">Users</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zero</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Projects</span><span style="color:#f92672">/</span><span style="color:#a6e22e">Personal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cm</span><span style="color:#f92672">-</span><span style="color:#a6e22e">operator</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gen</span> <span style="color:#a6e22e">object</span>:<span style="color:#a6e22e">headerFile</span>=<span style="color:#e6db74">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#a6e22e">paths</span>=<span style="color:#e6db74">&#34;./...&#34;</span>
<span style="color:#a6e22e">Next</span>: <span style="color:#a6e22e">implement</span> <span style="color:#a6e22e">your</span> <span style="color:#a6e22e">new</span> <span style="color:#a6e22e">API</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">generate</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">manifests</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">g</span>. <span style="color:#a6e22e">CRDs</span>,<span style="color:#a6e22e">CRs</span>) <span style="color:#a6e22e">with</span>:
<span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#a6e22e">make</span> <span style="color:#a6e22e">manifests</span>
</code></pre></div><p>命令执行了以下动作</p>
<ul>
<li>
<p>在PROJECT文件中增加API资源声明。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#75715e"># Code generated by tool. DO NOT EDIT.</span>
<span style="color:#75715e"># This file is used to track the info used to scaffold your project</span>
<span style="color:#75715e"># and allow the plugins properly work.</span>
<span style="color:#75715e"># More info: https://book.kubebuilder.io/reference/project-config.html</span>
<span style="color:#f92672">domain</span>: <span style="color:#ae81ff">huayun.com</span>
<span style="color:#f92672">layout</span>:
- <span style="color:#ae81ff">go.kubebuilder.io/v3</span>
<span style="color:#f92672">projectName</span>: <span style="color:#ae81ff">cm-operator</span>
<span style="color:#f92672">repo</span>: <span style="color:#ae81ff">huayun.com/cm-operator</span>
<span style="color:#f92672">resources</span>:
- <span style="color:#f92672">api</span>:
    <span style="color:#f92672">crdVersion</span>: <span style="color:#ae81ff">v1</span>
    <span style="color:#f92672">namespaced</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">controller</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#f92672">domain</span>: <span style="color:#ae81ff">huayun.com</span>
  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cloudmanagercontroller</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CloudManager</span>
  <span style="color:#f92672">path</span>: <span style="color:#ae81ff">huayun.com/cm-operator/api/v1</span>
  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</code></pre></div></li>
<li>
<p>新增CRD和CR描述文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">config
├── crd
│   ├── kustomization.yaml
│   ├── kustomizeconfig.yaml
│   └── patches
│       ├── cainjection_in_cloudmanagers.yaml
│       └── webhook_in_cloudmanagers.yaml
├── manager
│   ├── kustomization.yaml
│   └── manager.yaml
├── rbac
│   ├── auth_proxy_client_clusterrole.yaml
│   ├── auth_proxy_role.yaml
│   ├── auth_proxy_role_binding.yaml
│   ├── auth_proxy_service.yaml
│   ├── cloudmanager_editor_role.yaml
│   ├── cloudmanager_viewer_role.yaml
│   ├── kustomization.yaml
│   ├── leader_election_role.yaml
│   ├── leader_election_role_binding.yaml
│   ├── role_binding.yaml
│   └── service_account.yaml
└── samples
    └── cloudmanagercontroller_v1_cloudmanager.yaml

</code></pre></div></li>
<li>
<p>新增api的类型目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">api
└── v1
    ├── cloudmanager_types.go
    ├── groupversion_info.go
    └── zz_generated.deepcopy.go

</code></pre></div></li>
</ul>
<p>我们可以修改cloudmanager_types.go文件，增加custom spec</p>
<p>根据我们设计的Crd，修改如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!
</span><span style="color:#75715e">// NOTE: json tags are required.  Any new fields you add must have json tags for the fields to be serialized.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// CloudManagerSpec defines the desired state of CloudManager
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CloudManagerSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">Front</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">FrontSpec</span>    <span style="color:#e6db74">`json:&#34;front&#34;`</span>
	<span style="color:#a6e22e">Identity</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">IdentitySpec</span> <span style="color:#e6db74">`json:&#34;identity&#34;`</span>
	<span style="color:#a6e22e">Db</span>       <span style="color:#f92672">*</span><span style="color:#a6e22e">DbSpec</span>       <span style="color:#e6db74">`json:&#34;db&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FrontSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Deployment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeploymentSpec</span> <span style="color:#e6db74">`json:&#34;deployment&#34;`</span>
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IdentitySpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Deployment</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DeploymentSpec</span> <span style="color:#e6db74">`json:&#34;deployment&#34;`</span>
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DbSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">StatefulSet</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StatefulSetSpec</span> <span style="color:#e6db74">`json:&#34;statefulSet&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StorageSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Class</span>       <span style="color:#66d9ef">string</span>                            <span style="color:#e6db74">`json:&#34;class&#34;`</span>
	<span style="color:#a6e22e">AccessModes</span> <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeAccessMode</span> <span style="color:#e6db74">`json:&#34;accessModes&#34;`</span>
	<span style="color:#a6e22e">Size</span>        <span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">Quantity</span>                 <span style="color:#e6db74">`json:&#34;size&#34;`</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeploymentSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Image</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;image&#34;`</span>
	<span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>
}
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StatefulSetSpec</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Image</span>   <span style="color:#66d9ef">string</span>       <span style="color:#e6db74">`json:&#34;image&#34;`</span>
	<span style="color:#a6e22e">Name</span>    <span style="color:#66d9ef">string</span>       <span style="color:#e6db74">`json:&#34;name&#34;`</span>
	<span style="color:#a6e22e">Storage</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StorageSpec</span> <span style="color:#e6db74">`json:&#34;storage&#34;`</span>
}

<span style="color:#75715e">// CloudManagerStatus defines the observed state of CloudManager
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CloudManagerStatus</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Phase</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;phase,omitempty&#34;`</span>
}

<span style="color:#75715e">//+kubebuilder:object:root=true
</span><span style="color:#75715e">//+kubebuilder:subresource:status
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// CloudManager is the Schema for the cloudmanagers API
</span><span style="color:#75715e">// 增加打印列
</span><span style="color:#75715e">// +kubebuilder:printcolumn:name=&#34;Status&#34;,type=string,JSONPath=`.status.phase`
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CloudManager</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>

	<span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">CloudManagerSpec</span>   <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>
	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">CloudManagerStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>
}

<span style="color:#75715e">//+kubebuilder:object:root=true
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// CloudManagerList contains a list of CloudManager
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CloudManagerList</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
	<span style="color:#a6e22e">Items</span>           []<span style="color:#a6e22e">CloudManager</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">SchemeBuilder</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CloudManager</span>{}, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CloudManagerList</span>{})
}
</code></pre></div><ul>
<li>
<p>main.go启动时创建controller</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = (<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">CloudManagerReconciler</span>{
		<span style="color:#a6e22e">Client</span>: <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetClient</span>(),
		<span style="color:#a6e22e">Scheme</span>: <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetScheme</span>(),
	}).<span style="color:#a6e22e">SetupWithManager</span>(<span style="color:#a6e22e">mgr</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">setupLog</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to create controller&#34;</span>, <span style="color:#e6db74">&#34;controller&#34;</span>, <span style="color:#e6db74">&#34;CloudManager&#34;</span>)
		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
	}
</code></pre></div></li>
<li>
<p>每次修改API定义后，需要执行命令自动重新生成代码和CRD：</p>
<pre tabindex="0"><code>$ make generate
$ make manifests
</code></pre></li>
</ul>
<h4 id="实现controller">实现Controller</h4>
<p>假设一个cm实例创建时，要完成如下动作</p>
<ul>
<li>2个Deployment，包括frontend和identity</li>
<li>1个Statefulset，包括mariadb</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">Copyright 2023.
</span><span style="color:#75715e">
</span><span style="color:#75715e">Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span style="color:#75715e">you may not use this file except in compliance with the License.
</span><span style="color:#75715e">You may obtain a copy of the License at
</span><span style="color:#75715e">
</span><span style="color:#75715e">    http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#75715e">
</span><span style="color:#75715e">Unless required by applicable law or agreed to in writing, software
</span><span style="color:#75715e">distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#75715e">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#75715e">See the License for the specific language governing permissions and
</span><span style="color:#75715e">limitations under the License.
</span><span style="color:#75715e">*/</span>

<span style="color:#f92672">package</span> <span style="color:#a6e22e">controllers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;github.com/go-logr/logr&#34;</span>
	<span style="color:#a6e22e">appsv1</span> <span style="color:#e6db74">&#34;k8s.io/api/apps/v1&#34;</span>
	<span style="color:#a6e22e">corev1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/types&#34;</span>
	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/record&#34;</span>

	<span style="color:#a6e22e">ctrl</span> <span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime&#34;</span>
	<span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
	<span style="color:#e6db74">&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>

	<span style="color:#a6e22e">cloudmanagercontrollerv1</span> <span style="color:#e6db74">&#34;huayun.com/cm-operator/api/v1&#34;</span>
)

<span style="color:#75715e">// CloudManagerReconciler reconciles a CloudManager object
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CloudManagerReconciler</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">Scheme</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Scheme</span>
	<span style="color:#a6e22e">Recorder</span> <span style="color:#a6e22e">record</span>.<span style="color:#a6e22e">EventRecorder</span>
}

<span style="color:#75715e">//+kubebuilder:rbac:groups=cloudmanagercontroller.huayun.com,resources=cloudmanagers,verbs=get;list;watch;create;update;patch;delete
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=cloudmanagercontroller.huayun.com,resources=cloudmanagers/status,verbs=get;update;patch
</span><span style="color:#75715e">//+kubebuilder:rbac:groups=cloudmanagercontroller.huayun.com,resources=cloudmanagers/finalizers,verbs=update
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Reconcile is part of the main kubernetes reconciliation loop which aims to
</span><span style="color:#75715e">// move the current state of the cluster closer to the desired state.
</span><span style="color:#75715e">// TODO(user): Modify the Reconcile function to compare the state specified by
</span><span style="color:#75715e">// the CloudManager object against the actual cluster state, and then
</span><span style="color:#75715e">// perform operations to make the cluster state reflect the state specified by
</span><span style="color:#75715e">// the user.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// For more details, check Reconcile and its Result here:
</span><span style="color:#75715e">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.14.1/pkg/reconcile
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CloudManagerReconciler</span>) <span style="color:#a6e22e">Reconcile</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)

	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">WithValues</span>(<span style="color:#e6db74">&#34;cloudManager&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>)

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	phase1  fetch cloudManager by name
</span><span style="color:#75715e">	*/</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cm</span> <span style="color:#a6e22e">cloudmanagercontrollerv1</span>.<span style="color:#a6e22e">CloudManager</span>
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;fetching cloudManager Resource&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">NamespacedName</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable fetch cloudManager&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">IgnoreNotFound</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	phase2 clean up old resource which had owned by Cm Resource
</span><span style="color:#75715e">	*/</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">cleanupOwnedResources</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">logger</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to clean up old resources for this cloudManager&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">/*
</span><span style="color:#75715e">		phase3  create or update front identity db
</span><span style="color:#75715e">	*/</span>
	<span style="color:#a6e22e">frontDeploymentName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Front</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">frontDeploy</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">frontDeploymentName</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>,
		},
	}

	<span style="color:#75715e">//create or update front deployment
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">CreateOrUpdate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">frontDeploy</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">labels</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;controller&#34;</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>,
			<span style="color:#e6db74">&#34;app&#34;</span>:        <span style="color:#e6db74">&#34;front&#34;</span>,
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelector</span>{<span style="color:#a6e22e">MatchLabels</span>: <span style="color:#a6e22e">labels</span>}
		}
		<span style="color:#75715e">// set labels to template.objectMeta for our deployment
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> = <span style="color:#a6e22e">labels</span>
		}

		<span style="color:#a6e22e">containers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Container</span>{
			{
				<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;front-container&#34;</span>,
				<span style="color:#a6e22e">Image</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Front</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Image</span>,
			},
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> = <span style="color:#a6e22e">containers</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">SetControllerReference</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">frontDeploy</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Scheme</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to set ownerReference from CloudManager to FrontDeployment&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to ensure frontDeployment is correct&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//check front status
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">frontDeploymentName</span>, <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>}, <span style="color:#a6e22e">frontDeploy</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to get resource&#34;</span>, <span style="color:#e6db74">&#34;component&#34;</span>, <span style="color:#a6e22e">frontDeploymentName</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">ReadyReplicas</span> &lt; <span style="color:#a6e22e">frontDeploy</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Replicas</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{<span style="color:#a6e22e">Requeue</span>: <span style="color:#66d9ef">true</span>}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">//create or update  identity deployment
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">identityDeploymentName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Identity</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">identityDeploy</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">identityDeploymentName</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>,
		},
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">CreateOrUpdate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">identityDeploy</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">labels</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;controller&#34;</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>,
			<span style="color:#e6db74">&#34;app&#34;</span>:        <span style="color:#e6db74">&#34;identity&#34;</span>,
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelector</span>{<span style="color:#a6e22e">MatchLabels</span>: <span style="color:#a6e22e">labels</span>}
		}
		<span style="color:#75715e">// set labels to template.objectMeta for our deployment
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> = <span style="color:#a6e22e">labels</span>
		}

		<span style="color:#a6e22e">containers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Container</span>{
			{
				<span style="color:#a6e22e">Name</span>:    <span style="color:#e6db74">&#34;identity-container&#34;</span>,
				<span style="color:#a6e22e">Image</span>:   <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Identity</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Image</span>,
				<span style="color:#a6e22e">Command</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;sleep 60m&#34;</span>},
			},
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> = <span style="color:#a6e22e">containers</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">SetControllerReference</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">identityDeploy</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Scheme</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to set ownerReference from CloudManager to IdentityDeployment&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to ensure identityDeployment is correct&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//check  identity status
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">identityDeploymentName</span>, <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>}, <span style="color:#a6e22e">identityDeploy</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to get resource&#34;</span>, <span style="color:#e6db74">&#34;component&#34;</span>, <span style="color:#a6e22e">identityDeploymentName</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">ReadyReplicas</span> &lt; <span style="color:#a6e22e">identityDeploy</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Replicas</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{<span style="color:#a6e22e">Requeue</span>: <span style="color:#66d9ef">true</span>}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">//create or update db auth secret
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dbAuthSecretName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;auth&#34;</span>
	<span style="color:#a6e22e">dbAuthSecret</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Secret</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">dbAuthSecretName</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>,
		},
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">CreateOrUpdate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">dbAuthSecret</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">dbAuthSecret</span>.<span style="color:#a6e22e">Data</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">byte</span>{
			<span style="color:#e6db74">&#34;username&#34;</span>: []byte(<span style="color:#e6db74">&#34;root&#34;</span>),
			<span style="color:#e6db74">&#34;password&#34;</span>: []byte(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">RootPass</span>),
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">SetControllerReference</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">dbAuthSecret</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Scheme</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to set ownerReference from CloudManager to DbStatefulSet&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to ensure DbStatefulSet is correct&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//create or update db  statefulSet
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dbStatefulSetName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">dbStatefulSet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">StatefulSet</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">dbStatefulSetName</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>,
		},
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">CreateOrUpdate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">dbStatefulSet</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">labels</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;controller&#34;</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>,
			<span style="color:#e6db74">&#34;app&#34;</span>:        <span style="color:#e6db74">&#34;db&#34;</span>,
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Selector</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">LabelSelector</span>{<span style="color:#a6e22e">MatchLabels</span>: <span style="color:#a6e22e">labels</span>}
		}
		<span style="color:#75715e">// set labels to template.objectMeta for our statefulSet
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> = <span style="color:#a6e22e">labels</span>
		}
		<span style="color:#a6e22e">containers</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Container</span>{
			{
				<span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;db-container&#34;</span>,
				<span style="color:#a6e22e">Image</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Image</span>,
				<span style="color:#a6e22e">Env</span>: []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EnvVar</span>{
					{
						<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;MARIADB_ROOT_PASSWORD&#34;</span>,
						<span style="color:#a6e22e">ValueFrom</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EnvVarSource</span>{
							<span style="color:#a6e22e">SecretKeyRef</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">SecretKeySelector</span>{
								<span style="color:#a6e22e">Key</span>: <span style="color:#e6db74">&#34;password&#34;</span>,
								<span style="color:#a6e22e">LocalObjectReference</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">LocalObjectReference</span>{
									<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">dbAuthSecretName</span>,
								},
							},
						},
					},
				},
			},
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span> = <span style="color:#a6e22e">containers</span>
		}

		<span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">VolumeClaimTemplates</span> = []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeClaim</span>{
			<span style="color:#a6e22e">volumeClaimTemplates</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>),
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">SetControllerReference</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">dbStatefulSet</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Scheme</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to set ownerReference from CloudManager to DbStatefulSet&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to ensure DbStatefulSet is correct&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>{<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">dbStatefulSetName</span>, <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Namespace</span>}, <span style="color:#a6e22e">dbStatefulSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to get resource&#34;</span>, <span style="color:#e6db74">&#34;component&#34;</span>, <span style="color:#a6e22e">dbStatefulSetName</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">ReadyReplicas</span> &lt; <span style="color:#a6e22e">dbStatefulSet</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Replicas</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{<span style="color:#a6e22e">Requeue</span>: <span style="color:#66d9ef">true</span>}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	phase3 update cm status
</span><span style="color:#75715e">	*/</span>
	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Phase</span> = <span style="color:#e6db74">&#34;ready&#34;</span>
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>().<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unable to update cloudManager status&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//create event
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Recorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#e6db74">&#34;Updated&#34;</span>, <span style="color:#e6db74">&#34;Update cm.status.phase: %s&#34;</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">Phase</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// SetupWithManager sets up the controller with the Manager.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CloudManagerReconciler</span>) <span style="color:#a6e22e">SetupWithManager</span>(<span style="color:#a6e22e">mgr</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Manager</span>) <span style="color:#66d9ef">error</span> {

	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Recorder</span> = <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetEventRecorderFor</span>(<span style="color:#e6db74">&#34;CloudManager&#34;</span>)

	<span style="color:#75715e">// add  resource index to resource object which cloudManager resource owns
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetFieldIndexer</span>().<span style="color:#a6e22e">IndexField</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>{}, <span style="color:#a6e22e">resourceOwnerKey</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">rawObj</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Object</span>) []<span style="color:#66d9ef">string</span> {
		<span style="color:#75715e">// grab the deployment object, extract the owner...
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">deployment</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rawObj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>)
		<span style="color:#a6e22e">owner</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetControllerOf</span>(<span style="color:#a6e22e">deployment</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">owner</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#75715e">// ...make sure it&#39;s a Foo...
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">APIVersion</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">apiGVStr</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">Kind</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;CloudManager&#34;</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}

		<span style="color:#75715e">// ...and if so, return it
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">Name</span>}
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mgr</span>.<span style="color:#a6e22e">GetFieldIndexer</span>().<span style="color:#a6e22e">IndexField</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">StatefulSet</span>{}, <span style="color:#a6e22e">resourceOwnerKey</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">rawObj</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Object</span>) []<span style="color:#66d9ef">string</span> {
		<span style="color:#75715e">// grab the deployment object, extract the owner...
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">statefulSet</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rawObj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">StatefulSet</span>)
		<span style="color:#a6e22e">owner</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetControllerOf</span>(<span style="color:#a6e22e">statefulSet</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">owner</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#75715e">// ...make sure it&#39;s a Foo...
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">APIVersion</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">apiGVStr</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">Kind</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;CloudManager&#34;</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}

		<span style="color:#75715e">// ...and if so, return it
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">owner</span>.<span style="color:#a6e22e">Name</span>}
	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

  <span style="color:#75715e">//同时监听Service,StatefulSet,Deployment
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">NewControllerManagedBy</span>(<span style="color:#a6e22e">mgr</span>).
		<span style="color:#a6e22e">For</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cloudmanagercontrollerv1</span>.<span style="color:#a6e22e">CloudManager</span>{}).
		<span style="color:#a6e22e">Owns</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Service</span>{}).
		<span style="color:#a6e22e">Owns</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">StatefulSet</span>{}).
		<span style="color:#a6e22e">Owns</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">Deployment</span>{}).
		<span style="color:#a6e22e">Complete</span>(<span style="color:#a6e22e">r</span>)
}

<span style="color:#75715e">// cleanupOwnedResources will delete any existing Deployment resources that
</span><span style="color:#75715e">// were created for the given cm that no longer match the
</span><span style="color:#75715e">// cm.spec.front.name / identity.name  /  db.name field.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CloudManagerReconciler</span>) <span style="color:#a6e22e">cleanupOwnedResources</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">log</span> <span style="color:#a6e22e">logr</span>.<span style="color:#a6e22e">Logger</span>, <span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cloudmanagercontrollerv1</span>.<span style="color:#a6e22e">CloudManager</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;finding existing Deployments for Foo resource&#34;</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deployments</span> <span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">DeploymentList</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deployments</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">InNamespace</span>(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Namespace</span>), <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">MatchingFields</span>(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">resourceOwnerKey</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Name</span>})); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// Delete deployment if the deployment name doesn&#39;t match cm.spec.front or identity name
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">deployment</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">deployments</span>.<span style="color:#a6e22e">Items</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Front</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">||</span>
			<span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Identity</span>.<span style="color:#a6e22e">Deployment</span>.<span style="color:#a6e22e">Name</span> {
			<span style="color:#75715e">// If this deployment&#39;s name matches the one on the Cm resource
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// then do not delete it.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// Delete old deployment object which doesn&#39;t match cm.spec.front or identity name
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">deployment</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to delete Deployment resource&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;delete deployment resource: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Recorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#e6db74">&#34;Deleted&#34;</span>, <span style="color:#e6db74">&#34;Deleted deployment %q&#34;</span>, <span style="color:#a6e22e">deployment</span>.<span style="color:#a6e22e">Name</span>)
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">statefulSetList</span> <span style="color:#a6e22e">appsv1</span>.<span style="color:#a6e22e">StatefulSetList</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">statefulSetList</span>, <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">InNamespace</span>(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Namespace</span>), <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">MatchingFields</span>(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">resourceOwnerKey</span>: <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Name</span>})); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// Delete statefulSet if the statefulSet name doesn&#39;t match cm.spec.db.name
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">statefulSet</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">statefulSetList</span>.<span style="color:#a6e22e">Items</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">statefulSet</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Name</span> {
			<span style="color:#75715e">// If this statefulSet&#39;s name matches the one on the Cm resource
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// then do not delete it.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// Delete old statefulSet object which doesn&#39;t match cm.spec.deploymentName
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">statefulSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to delete StatefulSet resource&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}

		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;delete deployment resource: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">statefulSet</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Recorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeNormal</span>, <span style="color:#e6db74">&#34;Deleted&#34;</span>, <span style="color:#e6db74">&#34;Deleted statefulSet %q&#34;</span>, <span style="color:#a6e22e">statefulSet</span>.<span style="color:#a6e22e">Name</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">resourceOwnerKey</span> = <span style="color:#e6db74">&#34;.metadata.controller&#34;</span>
	<span style="color:#a6e22e">DataVolumeName</span>   = <span style="color:#e6db74">&#34;datadir&#34;</span>
	<span style="color:#a6e22e">apiGVStr</span>         = <span style="color:#a6e22e">cloudmanagercontrollerv1</span>.<span style="color:#a6e22e">GroupVersion</span>.<span style="color:#a6e22e">String</span>()
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">volumeClaimTemplates</span>(<span style="color:#a6e22e">cr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cloudmanagercontrollerv1</span>.<span style="color:#a6e22e">CloudManager</span>) <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeClaim</span> {
	<span style="color:#a6e22e">pvc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeClaim</span>{
		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
			<span style="color:#a6e22e">Namespace</span>:   <span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Namespace</span>,
			<span style="color:#a6e22e">Name</span>:        <span style="color:#a6e22e">DataVolumeName</span>,
			<span style="color:#a6e22e">Annotations</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{},
			<span style="color:#a6e22e">Labels</span>:      <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{},
			<span style="color:#a6e22e">OwnerReferences</span>: []<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">OwnerReference</span>{
				<span style="color:#f92672">*</span><span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">NewControllerRef</span>(<span style="color:#a6e22e">cr</span>, <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionKind</span>{
					<span style="color:#a6e22e">Group</span>:   <span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">GroupVersionKind</span>().<span style="color:#a6e22e">Group</span>,
					<span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">GroupVersionKind</span>().<span style="color:#a6e22e">Version</span>,
					<span style="color:#a6e22e">Kind</span>:    <span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Kind</span>,
				}),
			},
		},
		<span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeClaimSpec</span>{
			<span style="color:#a6e22e">StorageClassName</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Storage</span>.<span style="color:#a6e22e">Class</span>,
			<span style="color:#a6e22e">AccessModes</span>: []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PersistentVolumeAccessMode</span>{
				<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Storage</span>.<span style="color:#a6e22e">AccessModes</span>,
			},
			<span style="color:#a6e22e">Resources</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ResourceRequirements</span>{
				<span style="color:#a6e22e">Requests</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ResourceList</span>{
					<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ResourceStorage</span>: <span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Db</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">Storage</span>.<span style="color:#a6e22e">Size</span>,
				},
			},
		},
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pvc</span>
}

</code></pre></div><p>·执行</p>
<pre tabindex="0"><code>// 请求成功，不再排队
return ctrl.Result{}, nil
// 请求失败，重新加入队列
return ctrl.Result{}, err
// 请求因某种原因需要重新加入队列
return ctrl.Result{Requeue: true}, nil
// 请求因某种原因，需要在指定时间后重新加入队列
return ctrl.Result{RequeueAfter: time.Second*5}, nil
</code></pre><h4 id="heading"></h4>
<p><img src="https://pic-frank.oss-cn-beijing.aliyuncs.com/img/202303201747531.gif" alt="Screen Recording 2023-03-20 at 17.39.45"></p>
<h4 id="小结">小结</h4>
<p>相较于使用helm部署cm，controller更细化控制，日志，通知等事件都控制在内部代码中，更适合一个独立应用。（沃趣rds也是通过operator，来创建所有的服务）</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kunbernetes/" rel="tag">kunbernetes</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Frank Silva avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Frank Silva</span>
	</div>
	<div class="authorbox__description">
		Pursue Consummate Coding.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/post/oa-roadmap/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OaRoadmap</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/post/tmux-cheatsheet/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">tmux shortcuts</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Frank Silva.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>