<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Nginx转发规则 - Luluhome - a blog for sh , &#39;lulu&#39; is my cat</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Luluhome - a blog for sh , &#39;lulu&#39; is my cat" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Luluhome - a blog for sh , &#39;lulu&#39; is my cat</div>
					
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">Archives</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">
				
				<span class="menu__text">Tags</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx转发规则</h1>
			
		</header>
		
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#location">Location</a></li>
    <li><a href="#proxy_pass">proxy_pass</a></li>
  </ul>
</nav>
	</div>
</div><div class="content post__content clearfix">
			<h1 id="location">Location</h1>
<p>| Syntax:  | <code>**location** [ = | ~ | ~* | ^~ ] *uri* { ... }</code> <code>**location** @*name* { ... }</code> |
| :&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; |
| Default: | —                                                            |
| Context: | <code>server</code>, <code>location</code>                                         |</p>
<p>Sets configuration depending on a request URI.</p>
<p>The matching is performed against a normalized URI, after decoding the text encoded in the “<code>%XX</code>” form, resolving references to relative path components “<code>.</code>” and “<code>..</code>”, and possible <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#merge_slashes">compression</a> of two or more adjacent slashes into a single slash.</p>
<p>A location can either be defined by a prefix string, or by a regular expression. Regular expressions are specified with the preceding “<code>~*</code>” modifier (for case-insensitive matching), or the “<code>~</code>” modifier (for case-sensitive matching). To find location matching a given request, nginx first checks locations defined using the prefix strings (prefix locations). Among them, the location with the longest matching prefix is selected and remembered. Then regular expressions are checked, in the order of their appearance in the configuration file. The search of regular expressions terminates on the first match, and the corresponding configuration is used. If no match with a regular expression is found then the configuration of the prefix location remembered earlier is used.</p>
<p><code>location</code> blocks can be nested, with some exceptions mentioned below.</p>
<p>For case-insensitive operating systems such as macOS and Cygwin, matching with prefix strings ignores a case (0.7.7). However, comparison is limited to one-byte locales.</p>
<p>Regular expressions can contain captures (0.7.40) that can later be used in other directives.</p>
<p>If the longest matching prefix location has the “<code>^~</code>” modifier then regular expressions are not checked.</p>
<p>Also, using the “<code>=</code>” modifier it is possible to define an exact match of URI and location. If an exact match is found, the search terminates. For example, if a “<code>/</code>” request happens frequently, defining “<code>location = /</code>” will speed up the processing of these requests, as search terminates right after the first comparison. Such a location cannot obviously contain nested locations.</p>
<blockquote>
<p>In versions from 0.7.1 to 0.8.41, if a request matched the prefix location without the “<code>=</code>” and “<code>^~</code>” modifiers, the search also terminated and regular expressions were not checked.</p>
</blockquote>
<p>Let’s illustrate the above by an example:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="p">=</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">[</span> <span class="s">configuration</span> <span class="s">A</span> <span class="s">]</span>
<span class="err">}</span>

<span class="s">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">[</span> <span class="s">configuration</span> <span class="s">B</span> <span class="s">]</span>
<span class="err">}</span>

<span class="s">location</span> <span class="s">/documents/</span> <span class="p">{</span>
    <span class="kn">[</span> <span class="s">configuration</span> <span class="s">C</span> <span class="s">]</span>
<span class="err">}</span>

<span class="s">location</span> <span class="s">^~</span> <span class="s">/images/</span> <span class="p">{</span>
    <span class="kn">[</span> <span class="s">configuration</span> <span class="s">D</span> <span class="s">]</span>
<span class="err">}</span>

<span class="s">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.(gif|jpg|jpeg)</span>$ <span class="p">{</span>
    <span class="kn">[</span> <span class="s">configuration</span> <span class="s">E</span> <span class="s">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>The “<code>/</code>” request will match configuration A, the “<code>/index.html</code>” request will match configuration B, the “<code>/documents/document.html</code>” request will match configuration C, the “<code>/images/1.gif</code>” request will match configuration D, and the “<code>/documents/1.jpg</code>” request will match configuration E.</p>
<p>The “<code>@</code>” prefix defines a named location. Such a location is not used for a regular request processing, but instead used for request redirection. They cannot be nested, and cannot contain nested locations.</p>
<p>If a location is defined by a prefix string that ends with the slash character, and requests are processed by one of <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass">fastcgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_uwsgi_module.html#uwsgi_pass">uwsgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_scgi_module.html#scgi_pass">scgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_memcached_module.html#memcached_pass">memcached_pass</a>, or <a href="https://nginx.org/en/docs/http/ngx_http_grpc_module.html#grpc_pass">grpc_pass</a>, then the special processing is performed. In response to a request with URI equal to this string, but without the trailing slash, a permanent redirect with the code 301 will be returned to the requested URI with the slash appended. If this is not desired, an exact match of the URI and location could be defined like this:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/user/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://user.example.com</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">location</span> <span class="p">=</span> <span class="s">/user</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://login.example.com</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<h1 id="proxy_pass">proxy_pass</h1>
<table>
<thead>
<tr>
<th style="text-align:left">Syntax:</th>
<th><code>**proxy_pass** *URL*;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Default:</td>
<td>—</td>
</tr>
<tr>
<td style="text-align:left">Context:</td>
<td><code>location</code>, <code>if in location</code>, <code>limit_except</code></td>
</tr>
</tbody>
</table>
<p>Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “<code>http</code>” or “<code>https</code>” can be specified. The address can be specified as a domain name or IP address, and an optional port:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">proxy_pass http://localhost:8000/uri/;
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>or as a UNIX-domain socket path specified after the word “<code>unix</code>” and enclosed in colons:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">proxy_pass http://unix:/tmp/backend.socket:/uri/;
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">server group</a>.</p>
<p>Parameter value can contain variables. In this case, if an address is specified as a domain name, the name is searched among the described server groups, and, if not found, is determined using a <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">resolver</a>.</p>
<p>A request URI is passed to the server as follows:</p>
<ul>
<li>
<p>If the <code>proxy_pass</code> directive is specified with a URI, then when a request is passed to the server, the part of a normalized</p>
<p>request URI matching the location is replaced by a URI specified in the directive:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/name/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1/remote/</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
</li>
<li>
<p>If <code>proxy_pass</code> is specified without a URI, the request URI is passed to the server in the same form as sent by a client when the original request is processed, or the full normalized request URI is passed when processing the changed URI:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/some/path/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<blockquote>
<p>Before version 1.1.12, if <code>proxy_pass</code> is specified without a URI, the original request URI might be passed instead of the changed URI in some cases.</p>
</blockquote>
</li>
</ul>
<p>In some cases, the part of a request URI to be replaced cannot be determined:</p>
<ul>
<li>
<p>When location is specified using a regular expression, and also inside named locations.</p>
<p>In these cases, <code>proxy_pass</code> should be specified without a URI.</p>
</li>
<li>
<p>When the URI is changed inside a proxied location using the <code>rewrite</code> directive, and this same configuration will be used to process a request(<code>break</code>):</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/name/</span> <span class="p">{</span>
    <span class="kn">rewrite</span>    <span class="s">/name/([^/]+)</span> <span class="s">/users?name=</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>In this case, the URI specified in the directive is ignored and the full changed request URI is passed to the server.</p>
</li>
<li>
<p>When variables are used in <code>proxy_pass</code>:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">location</span> <span class="s">/name/</span> <span class="p">{</span>
    <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1</span><span class="nv">$request_uri</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></blockquote>
<p>In this case, if URI is specified in the directive, it is passed to the server as is, replacing the original request URI.</p>
</li>
<li>
<p>在nginx中配置proxy_pass时，当在后面的url加上了/，相当于是绝对根路径，则nginx不会把location中匹配的路径部分代理走;如果没有/，则会把匹配的路径部分也给代理走。</p>
</li>
</ul>
<p>首先是location进行的是模糊匹配</p>
<ol>
<li>没有“/”时，location /abc/def可以匹配/abc/defghi请求，也可以匹配/abc/def/ghi等</li>
<li>而有“/”时，location /abc/def/不能匹配/abc/defghi请求，只能匹配/abc/def/anything这样的请求</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">下面四种情况分别用http://192.168.1.4/proxy/test.html 进行访问。

第一种：

location  /proxy/ <span class="o">{</span>

proxy_pass http://127.0.0.1:81/<span class="p">;</span>

<span class="o">}</span>

结论：会被代理到http://127.0.0.1:81/test.html 这个url


第二种<span class="o">(</span>相对于第一种，最后少一个 /<span class="o">)</span>

location  /proxy/ <span class="o">{</span>

proxy_pass http://127.0.0.1:81<span class="p">;</span>

<span class="o">}</span>

结论：会被代理到http://127.0.0.1:81/proxy/test.html 这个url


第三种：

location  /proxy/ <span class="o">{</span>

proxy_pass http://127.0.0.1:81/ftlynx/<span class="p">;</span>

<span class="o">}</span>

结论：会被代理到http://127.0.0.1:81/ftlynx/test.html 这个url。


第四种<span class="o">(</span>相对于第三种，最后少一个 / <span class="o">)</span>：

location  /proxy/ <span class="o">{</span>

proxy_pass http://127.0.0.1:81/ftlynx<span class="p">;</span>

<span class="o">}</span>

结论：会被代理到http://127.0.0.1:81/ftlynxtest.html 这个url
</code></pre></td></tr></table>
</div>
</div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/nginx/" rel="tag">Nginx</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Luluhome - a blog for sh , &#39;lulu&#39; is my cat.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>