<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Nginx转发规则 - Lulu</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Nginx转发规则" />
<meta property="og:description" content="Location | Syntax: | **location** [ = | ~ | ~* | ^~ ] *uri* { ... } **location** @*name* { ... } | | :&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; | | Default: | — | | Context: | server, location |
Sets configuration depending on a request URI.
The matching is performed against a normalized URI, after decoding the text encoded in the “%XX” form, resolving references to relative path components “." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sunhao1256.github.io/post/nginx/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-28T10:14:49+08:00" />
<meta property="article:modified_time" content="2022-07-28T10:14:49+08:00" />


		<meta itemprop="name" content="Nginx转发规则">
<meta itemprop="description" content="Location | Syntax: | **location** [ = | ~ | ~* | ^~ ] *uri* { ... } **location** @*name* { ... } | | :&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; | | Default: | — | | Context: | server, location |
Sets configuration depending on a request URI.
The matching is performed against a normalized URI, after decoding the text encoded in the “%XX” form, resolving references to relative path components “."><meta itemprop="datePublished" content="2022-07-28T10:14:49+08:00" />
<meta itemprop="dateModified" content="2022-07-28T10:14:49+08:00" />
<meta itemprop="wordCount" content="1019">
<meta itemprop="keywords" content="Nginx," />
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nginx转发规则"/>
<meta name="twitter:description" content="Location | Syntax: | **location** [ = | ~ | ~* | ^~ ] *uri* { ... } **location** @*name* { ... } | | :&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; | | Default: | — | | Context: | server, location |
Sets configuration depending on a request URI.
The matching is performed against a normalized URI, after decoding the text encoded in the “%XX” form, resolving references to relative path components “."/>

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Lulu" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/placeholder.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Lulu</div>
					<div class="logo__tagline">Lulu is arrongant cat</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/k8s-client-informer%E6%9C%BA%E5%88%B6/">
				
				<span class="menu__text">K8s Client Informer mechanism</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx转发规则</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Frank Silva</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2022-07-28T10:14:49&#43;08:00">2022-07-28</time></div></div>
		</header>
		<div class="content post__content clearfix">
			<h1 id="location">Location</h1>
<p>| Syntax:  | <code>**location** [ = | ~ | ~* | ^~ ] *uri* { ... }</code> <code>**location** @*name* { ... }</code> |
| :&mdash;&mdash;- | &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash; |
| Default: | —                                                            |
| Context: | <code>server</code>, <code>location</code>                                         |</p>
<p>Sets configuration depending on a request URI.</p>
<p>The matching is performed against a normalized URI, after decoding the text encoded in the “<code>%XX</code>” form, resolving references to relative path components “<code>.</code>” and “<code>..</code>”, and possible <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#merge_slashes">compression</a> of two or more adjacent slashes into a single slash.</p>
<p>A location can either be defined by a prefix string, or by a regular expression. Regular expressions are specified with the preceding “<code>~*</code>” modifier (for case-insensitive matching), or the “<code>~</code>” modifier (for case-sensitive matching). To find location matching a given request, nginx first checks locations defined using the prefix strings (prefix locations). Among them, the location with the longest matching prefix is selected and remembered. Then regular expressions are checked, in the order of their appearance in the configuration file. The search of regular expressions terminates on the first match, and the corresponding configuration is used. If no match with a regular expression is found then the configuration of the prefix location remembered earlier is used.</p>
<p><code>location</code> blocks can be nested, with some exceptions mentioned below.</p>
<p>For case-insensitive operating systems such as macOS and Cygwin, matching with prefix strings ignores a case (0.7.7). However, comparison is limited to one-byte locales.</p>
<p>Regular expressions can contain captures (0.7.40) that can later be used in other directives.</p>
<p>If the longest matching prefix location has the “<code>^~</code>” modifier then regular expressions are not checked.</p>
<p>Also, using the “<code>=</code>” modifier it is possible to define an exact match of URI and location. If an exact match is found, the search terminates. For example, if a “<code>/</code>” request happens frequently, defining “<code>location = /</code>” will speed up the processing of these requests, as search terminates right after the first comparison. Such a location cannot obviously contain nested locations.</p>
<blockquote>
<p>In versions from 0.7.1 to 0.8.41, if a request matched the prefix location without the “<code>=</code>” and “<code>^~</code>” modifiers, the search also terminated and regular expressions were not checked.</p>
</blockquote>
<p>Let’s illustrate the above by an example:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/</span> {
    <span style="color:#f92672">[</span> <span style="color:#e6db74">configuration</span> <span style="color:#e6db74">A</span> <span style="color:#e6db74">]</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">location</span> <span style="color:#e6db74">/</span> {
    <span style="color:#f92672">[</span> <span style="color:#e6db74">configuration</span> <span style="color:#e6db74">B</span> <span style="color:#e6db74">]</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">location</span> <span style="color:#e6db74">/documents/</span> {
    <span style="color:#f92672">[</span> <span style="color:#e6db74">configuration</span> <span style="color:#e6db74">C</span> <span style="color:#e6db74">]</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/images/</span> {
    <span style="color:#f92672">[</span> <span style="color:#e6db74">configuration</span> <span style="color:#e6db74">D</span> <span style="color:#e6db74">]</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">\.(gif|jpg|jpeg)</span>$ {
    <span style="color:#f92672">[</span> <span style="color:#e6db74">configuration</span> <span style="color:#e6db74">E</span> <span style="color:#e6db74">]</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div></blockquote>
<p>The “<code>/</code>” request will match configuration A, the “<code>/index.html</code>” request will match configuration B, the “<code>/documents/document.html</code>” request will match configuration C, the “<code>/images/1.gif</code>” request will match configuration D, and the “<code>/documents/1.jpg</code>” request will match configuration E.</p>
<p>The “<code>@</code>” prefix defines a named location. Such a location is not used for a regular request processing, but instead used for request redirection. They cannot be nested, and cannot contain nested locations.</p>
<p>If a location is defined by a prefix string that ends with the slash character, and requests are processed by one of <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass">fastcgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_uwsgi_module.html#uwsgi_pass">uwsgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_scgi_module.html#scgi_pass">scgi_pass</a>, <a href="https://nginx.org/en/docs/http/ngx_http_memcached_module.html#memcached_pass">memcached_pass</a>, or <a href="https://nginx.org/en/docs/http/ngx_http_grpc_module.html#grpc_pass">grpc_pass</a>, then the special processing is performed. In response to a request with URI equal to this string, but without the trailing slash, a permanent redirect with the code 301 will be returned to the requested URI with the slash appended. If this is not desired, an exact match of the URI and location could be defined like this:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/user/</span> {
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://user.example.com</span>;
}

<span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/user</span> {
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://login.example.com</span>;
}
</code></pre></div></blockquote>
<h1 id="proxy_pass">proxy_pass</h1>
<table>
<thead>
<tr>
<th style="text-align:left">Syntax:</th>
<th><code>**proxy_pass** *URL*;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Default:</td>
<td>—</td>
</tr>
<tr>
<td style="text-align:left">Context:</td>
<td><code>location</code>, <code>if in location</code>, <code>limit_except</code></td>
</tr>
</tbody>
</table>
<p>Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “<code>http</code>” or “<code>https</code>” can be specified. The address can be specified as a domain name or IP address, and an optional port:</p>
<blockquote>
<pre tabindex="0"><code>proxy_pass http://localhost:8000/uri/;
</code></pre></blockquote>
<p>or as a UNIX-domain socket path specified after the word “<code>unix</code>” and enclosed in colons:</p>
<blockquote>
<pre tabindex="0"><code>proxy_pass http://unix:/tmp/backend.socket:/uri/;
</code></pre></blockquote>
<p>If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">server group</a>.</p>
<p>Parameter value can contain variables. In this case, if an address is specified as a domain name, the name is searched among the described server groups, and, if not found, is determined using a <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">resolver</a>.</p>
<p>A request URI is passed to the server as follows:</p>
<ul>
<li>
<p>If the <code>proxy_pass</code> directive is specified with a URI, then when a request is passed to the server, the part of a normalized</p>
<p>request URI matching the location is replaced by a URI specified in the directive:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/name/</span> {
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1/remote/</span>;
}
</code></pre></div></blockquote>
</li>
<li>
<p>If <code>proxy_pass</code> is specified without a URI, the request URI is passed to the server in the same form as sent by a client when the original request is processed, or the full normalized request URI is passed when processing the changed URI:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/some/path/</span> {
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1</span>;
}
</code></pre></div></blockquote>
<blockquote>
<p>Before version 1.1.12, if <code>proxy_pass</code> is specified without a URI, the original request URI might be passed instead of the changed URI in some cases.</p>
</blockquote>
</li>
</ul>
<p>In some cases, the part of a request URI to be replaced cannot be determined:</p>
<ul>
<li>
<p>When location is specified using a regular expression, and also inside named locations.</p>
<p>In these cases, <code>proxy_pass</code> should be specified without a URI.</p>
</li>
<li>
<p>When the URI is changed inside a proxied location using the <code>rewrite</code> directive, and this same configuration will be used to process a request(<code>break</code>):</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/name/</span> {
    <span style="color:#f92672">rewrite</span>    <span style="color:#e6db74">/name/([^/]+)</span> <span style="color:#e6db74">/users?name=</span>$1 <span style="color:#e6db74">break</span>;
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1</span>;
}
</code></pre></div></blockquote>
<p>In this case, the URI specified in the directive is ignored and the full changed request URI is passed to the server.</p>
</li>
<li>
<p>When variables are used in <code>proxy_pass</code>:</p>
<blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/name/</span> {
    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://127.0.0.1</span>$request_uri;
}
</code></pre></div></blockquote>
<p>In this case, if URI is specified in the directive, it is passed to the server as is, replacing the original request URI.</p>
</li>
<li>
<p>在nginx中配置proxy_pass时，当在后面的url加上了/，相当于是绝对根路径，则nginx不会把location中匹配的路径部分代理走;如果没有/，则会把匹配的路径部分也给代理走。</p>
</li>
</ul>
<p>首先是location进行的是模糊匹配</p>
<ol>
<li>没有“/”时，location /abc/def可以匹配/abc/defghi请求，也可以匹配/abc/def/ghi等</li>
<li>而有“/”时，location /abc/def/不能匹配/abc/defghi请求，只能匹配/abc/def/anything这样的请求</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">下面四种情况分别用http://192.168.1.4/proxy/test.html 进行访问。

第一种：

location  /proxy/ <span style="color:#f92672">{</span>

proxy_pass http://127.0.0.1:81/;

<span style="color:#f92672">}</span>

结论：会被代理到http://127.0.0.1:81/test.html 这个url


第二种<span style="color:#f92672">(</span>相对于第一种，最后少一个 /<span style="color:#f92672">)</span>

location  /proxy/ <span style="color:#f92672">{</span>

proxy_pass http://127.0.0.1:81;

<span style="color:#f92672">}</span>

结论：会被代理到http://127.0.0.1:81/proxy/test.html 这个url


第三种：

location  /proxy/ <span style="color:#f92672">{</span>

proxy_pass http://127.0.0.1:81/ftlynx/;

<span style="color:#f92672">}</span>

结论：会被代理到http://127.0.0.1:81/ftlynx/test.html 这个url。


第四种<span style="color:#f92672">(</span>相对于第三种，最后少一个 / <span style="color:#f92672">)</span>：

location  /proxy/ <span style="color:#f92672">{</span>

proxy_pass http://127.0.0.1:81/ftlynx;

<span style="color:#f92672">}</span>

结论：会被代理到http://127.0.0.1:81/ftlynxtest.html 这个url
</code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/nginx/" rel="tag">Nginx</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Frank Silva avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Frank Silva</span>
	</div>
	<div class="authorbox__description">
		Pursue Consummate Coding.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/post/wireshark/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Wireshark</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/post/vim_keyboard_shortcuts/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">VIM Keyboard Shortcuts</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 Frank Silva.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>