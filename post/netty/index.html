<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Netty - Luluhome - a blog for sh , &#39;lulu&#39; is my cat</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="sh" /><meta name="description" content="netty是在什么地方创建SeverChannel的 在BootStrap调用bind方法时创建 1 2 3 private ChannelFuture doBind(final SocketAddress localAddress) { final ChannelFuture regFuture = this.initAndRegister(); } initAndR" /><meta name="keywords" content="luluhome, java, blog" />






<meta name="generator" content="Hugo 0.89.0 with theme even" />


<link rel="canonical" href="http://luluhome.site/post/netty/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Netty" />
<meta property="og:description" content="netty是在什么地方创建SeverChannel的 在BootStrap调用bind方法时创建 1 2 3 private ChannelFuture doBind(final SocketAddress localAddress) { final ChannelFuture regFuture = this.initAndRegister(); } initAndR" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://luluhome.site/post/netty/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-11T14:43:18+08:00" />
<meta property="article:modified_time" content="2022-10-13T16:34:57+08:00" />

<meta itemprop="name" content="Netty">
<meta itemprop="description" content="netty是在什么地方创建SeverChannel的 在BootStrap调用bind方法时创建 1 2 3 private ChannelFuture doBind(final SocketAddress localAddress) { final ChannelFuture regFuture = this.initAndRegister(); } initAndR"><meta itemprop="datePublished" content="2022-01-11T14:43:18+08:00" />
<meta itemprop="dateModified" content="2022-10-13T16:34:57+08:00" />
<meta itemprop="wordCount" content="9039">
<meta itemprop="keywords" content="Netty," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Netty"/>
<meta name="twitter:description" content="netty是在什么地方创建SeverChannel的 在BootStrap调用bind方法时创建 1 2 3 private ChannelFuture doBind(final SocketAddress localAddress) { final ChannelFuture regFuture = this.initAndRegister(); } initAndR"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">luluhome</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">luluhome</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Netty</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-11 </span>
        
          <span class="more-meta"> 9039 words </span>
          <span class="more-meta"> 19 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#netty是在什么地方创建severchannel的">netty是在什么地方创建SeverChannel的</a></li>
    <li><a href="#serverbootstrapacceptor">ServerBootstrapAcceptor</a></li>
    <li><a href="#nioeventloopgroupnioeventloop的关系">NioEventLoopGroup、NioEventLoop的关系</a></li>
    <li><a href="#nioeventloop启动">NioEventLoop启动</a></li>
    <li><a href="#nioeventloop的run方法">NioEventLoop的run方法</a></li>
    <li><a href="#服务端创建客户端连接流程">服务端创建客户端连接流程</a></li>
    <li><a href="#pipeline">Pipeline</a>
      <ul>
        <li><a href="#初始化">初始化</a></li>
        <li><a href="#channelhandlercontext">ChannelHandlerContext</a></li>
        <li><a href="#channelhandler的添加">ChannelHandler的添加</a></li>
        <li><a href="#channelhandler删除">ChannelHandler删除</a></li>
        <li><a href="#inboud事件">Inboud事件</a></li>
        <li><a href="#outbound事件">outBound事件</a></li>
        <li><a href="#ctxchannelwrite和ctxwrite的区别">ctx.channel().write()和ctx.write()的区别</a></li>
      </ul>
    </li>
    <li><a href="#bytebuf">ByteBuf</a></li>
    <li><a href="#bytebuffallocator">ByteBuffAllocator</a>
      <ul>
        <li><a href="#unpooledbytebufallocator">UnpooledByteBufAllocator</a>
          <ul>
            <li><a href="#分配堆内内存">分配堆内内存</a></li>
            <li><a href="#分配堆外内存">分配堆外内存</a></li>
          </ul>
        </li>
        <li><a href="#pooledbytebufallocator">PooledByteBufAllocator</a>
          <ul>
            <li><a href="#分配堆内内存-1">分配堆内内存</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#bytetomessagedecoder">ByteToMessageDecoder</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="netty是在什么地方创建severchannel的">netty是在什么地方创建SeverChannel的</h1>
<p>在BootStrap调用bind方法时创建</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">initAndRegister</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>initAndRegister方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>channelFactory是在bootstrap配置class时实例化的</p>
<p>在AbstractBootstrap中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="n">B</span> <span class="nf">channel</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">channelClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">channelFactory</span><span class="o">((</span><span class="n">io</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">ChannelFactory</span><span class="o">)(</span><span class="k">new</span> <span class="n">ReflectiveChannelFactory</span><span class="o">((</span><span class="n">Class</span><span class="o">)</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">channelClass</span><span class="o">,</span> <span class="s">&#34;channelClass&#34;</span><span class="o">))));</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因此是直接通过反射，创建了NioServerSocketChannel.class</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NioServerSocketChannel</span> <span class="kd">extends</span> <span class="n">AbstractNioMessageChannel</span> <span class="kd">implements</span> <span class="n">ServerSocketChannel</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ChannelMetadata</span> <span class="n">METADATA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChannelMetadata</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">16</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">SelectorProvider</span> <span class="n">DEFAULT_SELECTOR_PROVIDER</span> <span class="o">=</span> <span class="n">SelectorProvider</span><span class="o">.</span><span class="na">provider</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">InternalLogger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">InternalLoggerFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServerSocketChannelConfig</span> <span class="n">config</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">ServerSocketChannel</span> <span class="nf">newSocket</span><span class="o">(</span><span class="n">SelectorProvider</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="c1">//实际上就是调用了java的方法
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="na">openServerSocketChannel</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to open a server socket.&#34;</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">newSocket</span><span class="o">(</span><span class="n">DEFAULT_SELECTOR_PROVIDER</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">(</span><span class="n">SelectorProvider</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">newSocket</span><span class="o">(</span><span class="n">provider</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="c1">//super方法中配置了阻塞
</span><span class="c1"></span>    <span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">ServerSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">((</span><span class="n">Channel</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">16</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">NioServerSocketChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="nf">AbstractNioChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">,</span> <span class="n">SelectableChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span> <span class="o">=</span> <span class="n">readInterestOp</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">//设置阻塞
</span><span class="c1"></span>        <span class="n">ch</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var7</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var6</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to close a partially initialized socket.&#34;</span><span class="o">,</span> <span class="n">var6</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to enter non-blocking mode.&#34;</span><span class="o">,</span> <span class="n">var7</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="nf">AbstractChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newId</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">unsafe</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newUnsafe</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">pipeline</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newChannelPipeline</span><span class="o">();</span><span class="c1">//创建了管道
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="serverbootstrapacceptor">ServerBootstrapAcceptor</h1>
<p>服务端不管之前增加了多少handler，最后都会增加ServerBootstrapAcceptor</p>
<p>在ServerBootstrap.class中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">newOptionsArray</span><span class="o">(),</span> <span class="n">logger</span><span class="o">);</span>
    <span class="n">setAttributes</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="o">(</span><span class="n">Entry</span><span class="o">[])</span><span class="k">this</span><span class="o">.</span><span class="na">attrs0</span><span class="o">().</span><span class="na">entrySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">EMPTY_ATTRIBUTE_ARRAY</span><span class="o">));</span>
    <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">EventLoopGroup</span> <span class="n">currentChildGroup</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">childGroup</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">ChannelHandler</span> <span class="n">currentChildHandler</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">childHandler</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">Entry</span><span class="o">[]</span> <span class="n">currentChildOptions</span><span class="o">;</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">childOptions</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">currentChildOptions</span> <span class="o">=</span> <span class="o">(</span><span class="n">Entry</span><span class="o">[])</span><span class="k">this</span><span class="o">.</span><span class="na">childOptions</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">EMPTY_OPTION_ARRAY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">Entry</span><span class="o">&lt;</span><span class="n">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;[]</span> <span class="n">currentChildAttrs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Entry</span><span class="o">[])</span><span class="k">this</span><span class="o">.</span><span class="na">childAttrs</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">toArray</span><span class="o">(</span><span class="n">EMPTY_ATTRIBUTE_ARRAY</span><span class="o">);</span>
    <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">Channel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="kd">final</span> <span class="n">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="n">ChannelHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">handler</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="n">handler</span><span class="o">});</span>
            <span class="o">}</span>

            <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                  <span class="c1">//在这里加入了默认的
</span><span class="c1"></span>                  <span class="c1">//以后新的请求的都通过这个连接器处理，给新的连接分配一个nio线程
</span><span class="c1"></span>                    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelHandler</span><span class="o">[]{</span><span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">.</span><span class="na">ServerBootstrapAcceptor</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="n">currentChildGroup</span><span class="o">,</span> <span class="n">currentChildHandler</span><span class="o">,</span> <span class="n">currentChildOptions</span><span class="o">,</span> <span class="n">currentChildAttrs</span><span class="o">)});</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>netty服务端启动的几个过程：创建channel（创建jdk底层channel）、init初始化（最主要是添加连接器serverBootstrapAcceptor）、register（把第一步jdk底层创建channel注册到selector上面，并且把这个NioServerSocketChannel作为attachment添加进去），doBind（绑定端口，实现监听accept事件）</p>
<ul>
<li>
<p>1、服务端的socket在哪里初始化？</p>
<p>在bind方法中，initAndRegister中，实例化SocketChannel，使用的是反射方式，传入的就是bootstrap配置的channel.class。底层还是jdk的ServerSocketChannel对应普通方式的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
<span class="c1">//设置为非阻塞模式
</span><span class="c1"></span><span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>register是把创建好的注册到selector上，但没有监听事件，对应的是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//监听客户端请求
</span><span class="c1">//0表示只注册，不监听事件
</span><span class="c1"></span><span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">ServerSocketChannel</span> <span class="nf">newSocket</span><span class="o">(</span><span class="n">SelectorProvider</span> <span class="n">provider</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="na">openServerSocketChannel</span><span class="o">();</span><span class="c1">//创建jdk的ServerSocketChannel
</span><span class="c1"></span>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ChannelException</span><span class="o">(</span><span class="s">&#34;Failed to open a server socket.&#34;</span><span class="o">,</span> <span class="n">var2</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>2、在哪里进行accept连接？</p>
<p>还是在bind方法中，doBind最终底层调用了jdk的端口绑定和监听accpet事件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="nf">NioServerSocketChannel</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">channels</span><span class="o">.</span><span class="na">ServerSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">((</span><span class="n">Channel</span><span class="o">)</span><span class="kc">null</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">16</span><span class="o">);</span><span class="c1">//16就是SelectionKey.OP_ACCEPT 1&lt;&lt;4
</span><span class="c1"></span>        <span class="k">this</span><span class="o">.</span><span class="na">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">NioServerSocketChannelConfig</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>对应普通的就是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">),</span><span class="n">1024</span><span class="o">);</span>
<span class="c1">//监听客户端请求
</span><span class="c1"></span><span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>bind最终是在NioServerSocketChannel执行的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">7</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">javaChannel</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>accpet最终是在AbstractNioChannel的doBeginRead方法中，注册了构造方法传来的16，即accpet事件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="k">this</span><span class="o">.</span><span class="na">readInterestOp</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id="nioeventloopgroupnioeventloop的关系">NioEventLoopGroup、NioEventLoop的关系</h1>
<p>在NioEventLoopGroup实例化的时候，会做如下动作</p>
<ul>
<li>
<p>创建线程创建(执行)器：new ThreadPerTaskExecutor()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="nf">MultithreadEventExecutorGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">terminatedChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">terminationFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultPromise</span><span class="o">(</span><span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">nThreads</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;nThreads: %d (expected: &gt; 0)&#34;</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//创建线程执行器
</span><span class="c1"></span>            <span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPerTaskExecutor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">newDefaultThreadFactory</span><span class="o">());</span>
        <span class="o">}</span>

            <span class="k">this</span><span class="o">.</span><span class="na">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventExecutor</span><span class="o">[</span><span class="n">nThreads</span><span class="o">];</span>

            <span class="kt">int</span> <span class="n">j</span><span class="o">;</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nThreads</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">var18</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">var18</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                  <span class="c1">//填充child
</span><span class="c1"></span>                    <span class="k">this</span><span class="o">.</span><span class="na">children</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">newChild</span><span class="o">((</span><span class="n">Executor</span><span class="o">)</span><span class="n">executor</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">var18</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var19</span><span class="o">)</span> <span class="o">{</span>

</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>构造NioEventLoop：for{newChild()}</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">protected</span> <span class="n">EventLoop</span> <span class="nf">newChild</span><span class="o">(</span><span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="c1">//填充的就是nioEventLoop 
</span><span class="c1"></span>      <span class="k">return</span> <span class="k">new</span> <span class="n">NioEventLoop</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="o">(</span><span class="n">SelectorProvider</span><span class="o">)</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">],</span> <span class="o">((</span><span class="n">SelectStrategyFactory</span><span class="o">)</span><span class="n">args</span><span class="o">[</span><span class="n">1</span><span class="o">]).</span><span class="na">newSelectStrategy</span><span class="o">(),</span> <span class="o">(</span><span class="n">RejectedExecutionHandler</span><span class="o">)</span><span class="n">args</span><span class="o">[</span><span class="n">2</span><span class="o">]);</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建线程选择器：chooserFactory.newChooser()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PowerOfTowEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>

        <span class="n">PowerOfTowEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">executors</span><span class="o">[</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">];</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GenericEventExecutorChooser</span> <span class="kd">implements</span> <span class="n">EventExecutorChooser</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">;</span>

        <span class="n">GenericEventExecutorChooser</span><span class="o">(</span><span class="n">EventExecutor</span><span class="o">[]</span> <span class="n">executors</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">executors</span> <span class="o">=</span> <span class="n">executors</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">EventExecutor</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">executors</span><span class="o">[</span><span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">idx</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">executors</span><span class="o">.</span><span class="na">length</span><span class="o">)];</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>模取运算除了%，还可以用&amp;（length-1）</p>
</li>
<li>
<p>线程创建与运行的流程</p>
<ul>
<li>
<p>NioEventLoopGroup顾名思义，就是NioEventLoopGroup的集合，内部维护了children数组，数组的内容就是NioEventLoop</p>
</li>
<li>
<p>当调用Loop去execute的时候，实际上是调用线程执行器ThreadPerTaskExecutor去执行，内部DefaultThreadFactory就是创建了FastThreadLocalThread线程。</p>
</li>
<li>
<p>Loop的execute方法，除了用DefaultThreadFactory创建并运行FastThreadLocalThread线程外，还会将任务放入Loop自身维护的一个无锁队列。并且运行自身的run方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStartThread</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">assert</span> <span class="n">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">updateLastExecutionTime</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">run</span><span class="o">();</span><span class="c1">//调用run方法
</span><span class="c1"></span>

<span class="c1">// nioEventLoop的run方法,无线循环去消费队列
</span><span class="c1"></span>             <span class="k">for</span><span class="o">(;;)</span>
               <span class="o">.....</span>
               <span class="o">....</span>
               <span class="o">....</span>
              <span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
              <span class="kt">boolean</span> <span class="n">ranTasks</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="n">100</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">processSelectedKeys</span><span class="o">();</span>
                  <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                  <span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>                  <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">();</span>
                <span class="o">}</span>
              <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                  <span class="n">processSelectedKeys</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                  <span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>                  <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
                  <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="n">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span><span class="c1">//通过ioRatio控制消费任务的速度，这里就是不断的循环去消费
</span><span class="c1"></span>                <span class="o">}</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// This will run the minimum number of tasks
</span><span class="c1"></span>              <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>总结</p>
<p>在创建NioEventLoopGroup后，内部会维护了一个children，children的内容就是nioEventLoop，并且创建loop的时候为每个loop创建了内部的无锁队列，默认长度是系统核心的2倍，然后调用group的register或者execute方法，都会执行next去取一个loop，next方法就是模取循环下一个线程。</p>
<p>loop会执行execute方法，实现会将任务Runnable放入队列。然后第一次运行时调用了ThreadFactory去创建了新线程，这个新线程并不是直接就开始执行任务，而是无限循环消费loop内部维护的无锁队列。达到了，一个loop一个线程。</p>
</li>
</ul>
<h1 id="nioeventloop启动">NioEventLoop启动</h1>
<p>在绑定端口的时候做了启动线程的动作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="na">CLOSE_ON_FAILURE</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的channel的eventLoop是通过register方法去绑定的，是在一开始Bootstrap的intAndRegister方法中执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
    <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
                <span class="k">return</span> <span class="o">(</span><span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">)).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="o">(</span><span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="k">new</span> <span class="n">FailedChannel</span><span class="o">(),</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">)).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>

      <span class="c1">//从group取一个loop绑定到channel上
</span><span class="c1"></span>        <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">config</span><span class="o">().</span><span class="na">group</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">isRegistered</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="nioeventloop的run方法">NioEventLoop的run方法</h1>
<ul>
<li>
<p>select()检查是否有io事件</p>
<p>netty在这里检查是否需要select，需要的话，直接调用jdk的select方法，进行阻塞。</p>
<p>jdk的select方法，在linux下，会发生没有事件，但是select方法被触发导致的空轮训bug</p>
<p>netty的解决方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
<span class="c1">//检查当前时间-本应该阻塞的时间&gt;=阻塞之前的时间，即发生阻塞了。没有空轮训
</span><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">currentTimeNanos</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
  <span class="c1">//否则，空轮训超过默认的512次，重建selector
</span><span class="c1"></span><span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">selectCnt</span> <span class="o">&gt;=</span> <span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&#34;</span><span class="o">,</span> <span class="n">selectCnt</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">rebuildSelector</span><span class="o">();</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>
    <span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="k">break</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>rebuildSelector()方法就是将原来selector上的所有keys，绑定到新的selector上</p>
</blockquote>
</li>
<li>
<p>processSelectedKeys()：处理io任务，即selectionKey中ready的事件，如accept、connect、read、write等</p>
<p>底层取轮询io事件，都是通过NioUnsafe去处理的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processSelectedKey</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">k</span><span class="o">,</span> <span class="n">AbstractNioChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">AbstractNioChannel</span><span class="o">.</span><span class="na">NioUnsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">k</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">eventLoop</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If the channel implementation throws an exception because there is no event loop, we ignore this
</span><span class="c1"></span>                <span class="c1">// because we are only trying to determine if ch is registered to this event loop and thus has authority
</span><span class="c1"></span>                <span class="c1">// to close ch.
</span><span class="c1"></span>                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop
</span><span class="c1"></span>            <span class="c1">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is
</span><span class="c1"></span>            <span class="c1">// still healthy and should not be closed.
</span><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/5125
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// close the channel if the key is not valid anymore
</span><span class="c1"></span>                <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
          <span class="c1">//处理各种事件
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">readyOps</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">readyOps</span><span class="o">();</span>
            <span class="c1">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise
</span><span class="c1"></span>            <span class="c1">// the NIO JDK channel implementation may throw a NotYetConnectedException.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking
</span><span class="c1"></span>                <span class="c1">// See https://github.com/netty/netty/issues/924
</span><span class="c1"></span>                <span class="kt">int</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
                <span class="n">ops</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
                <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>

                <span class="n">unsafe</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write
</span><span class="c1"></span>                <span class="n">ch</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">forceFlush</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead
</span><span class="c1"></span>            <span class="c1">// to a spin loop
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">readyOps</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">unsafe</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">unsafe</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">unsafe</span><span class="o">.</span><span class="na">voidPromise</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>runAllTasks()：处理异步任务队列里面的任务，也就是添加到taskQueue中的任务，如bind、channelActive等</p>
<p>这里有个ioRatio，就是执行io任务和非io任务的时间比。用户可以自行设置。默认为50，可以看源码。如果是100的话，先执行完io任务，执行完之后才执行非io任务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">                <span class="n">selectCnt</span><span class="o">++;</span>
                <span class="n">cancelledKeys</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">needsToSelectAgain</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">ranTasks</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="n">100</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">processSelectedKeys</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>                        <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">processSelectedKeys</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>                        <span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
                        <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="n">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">ranTasks</span> <span class="o">=</span> <span class="n">runAllTasks</span><span class="o">(</span><span class="n">0</span><span class="o">);</span> <span class="c1">// This will run the minimum number of tasks
</span><span class="c1"></span>                <span class="o">}</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">ranTasks</span> <span class="o">||</span> <span class="n">strategy</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">&gt;</span> <span class="n">MIN_PREMATURE_SELECTOR_RETURNS</span> <span class="o">&amp;&amp;</span> <span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row for Selector {}.&#34;</span><span class="o">,</span>
                                <span class="n">selectCnt</span> <span class="o">-</span> <span class="n">1</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">unexpectedSelectorWakeup</span><span class="o">(</span><span class="n">selectCnt</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// Unexpected wakeup (unusual case)
</span><span class="c1"></span>                    <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">runAllTasks</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeoutNanos</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">fetchFromScheduledTaskQueue</span><span class="o">();</span><span class="c1">//将定时任务队列里的到期任务放入队列中，如果队列满了，还放在定时任务队列里
</span><span class="c1"></span>    <span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">pollTask</span><span class="o">();</span><span class="c1">//取一个任务出来
</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">afterRunningAllTasks</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">long</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">timeoutNanos</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">?</span> <span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">timeoutNanos</span> <span class="o">:</span> <span class="n">0</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">runTasks</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">lastExecutionTime</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="n">safeExecute</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>

        <span class="n">runTasks</span> <span class="o">++;</span>

        <span class="c1">// Check timeout every 64 tasks because nanoTime() is relatively expensive.
</span><span class="c1"></span>        <span class="c1">// XXX: Hard-coded value - will make it configurable if it is really a problem.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">runTasks</span> <span class="o">&amp;</span> <span class="n">0x3F</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">lastExecutionTime</span> <span class="o">=</span> <span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastExecutionTime</span> <span class="o">&gt;=</span> <span class="n">deadline</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

      <span class="c1">//不断处理任务
</span><span class="c1"></span>        <span class="n">task</span> <span class="o">=</span> <span class="n">pollTask</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">lastExecutionTime</span> <span class="o">=</span> <span class="n">ScheduledFutureTask</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">afterRunningAllTasks</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastExecutionTime</span> <span class="o">=</span> <span class="n">lastExecutionTime</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>定时任务的场景，例如心跳处理</p>
</blockquote>
</li>
</ul>
<h1 id="服务端创建客户端连接流程">服务端创建客户端连接流程</h1>
<p>processSelectedKeys方法处理客户端连接，最后是落在底层的unsafe上。</p>
<p>read方法最后会通知到管道上，通知所有的handler，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">assert</span> <span class="n">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ChannelConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">RecvByteBufAllocator</span><span class="o">.</span><span class="na">Handle</span> <span class="n">allocHandle</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">().</span><span class="na">recvBufAllocHandle</span><span class="o">();</span>
    <span class="n">allocHandle</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="n">closed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">Throwable</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">do</span> <span class="o">{</span>
              <span class="c1">//创建NioSocketChannel
</span><span class="c1"></span>                <span class="kt">int</span> <span class="n">localRead</span> <span class="o">=</span> <span class="n">doReadMessages</span><span class="o">(</span><span class="n">readBuf</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">closed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="n">allocHandle</span><span class="o">.</span><span class="na">incMessagesRead</span><span class="o">(</span><span class="n">localRead</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">continueReading</span><span class="o">(</span><span class="n">allocHandle</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exception</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">readBuf</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
            <span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="c1">//管道传入NioSocketChannel
</span><span class="c1"></span>            <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">readBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>而我们知道在一开始创建NioServerSocketChannel的时候，在init中最后加入了ServerBootstrapAcceptor。而ServerBootstrapAcceptor就是处理客户端连接的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">        <span class="nd">@Override</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Channel</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="n">Channel</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>

          <span class="c1">//得到上面的NioSocketChannel
</span><span class="c1"></span>          <span class="c1">//将一开始代码中的childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {}传进来
</span><span class="c1"></span>            <span class="n">child</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">childHandler</span><span class="o">);</span>
          <span class="c1">//设置通道配置
</span><span class="c1"></span>            <span class="n">setChannelOptions</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childOptions</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>
          <span class="c1">//设置属性  
</span><span class="c1"></span>          <span class="n">setAttributes</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childAttrs</span><span class="o">);</span>

            <span class="k">try</span> <span class="o">{</span>
              <span class="c1">//worker线程组注册channel
</span><span class="c1"></span>                <span class="n">childGroup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">child</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>		
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>小结</p>
<p>Server在获取到读事件后，创建了客户端的SocketChannel，并且通过pipeline通知到服务端初始化时创建的ServerBootstrapAcceptor，<strong>通过ServerBootstrapAcceptor初始化childHandler</strong>，使用worker组进行注册SocketChannel，并且创建客户端Channel默认的监听事件时read，然后就和服务端一样，通过默认的HeadContext进行read方法，默认都是自动读的。然后就是通过group创建新线程去工作。循环调底层的jdk方法。再通过pipeline通知到各个handler</p>
</li>
</ul>
<h1 id="pipeline">Pipeline</h1>
<ul>
<li>
<p>netty是如何判断ChannelHandler类型的</p>
<p>答：通过传入是inbound还是outbound</p>
</li>
<li>
<p>对于ChannelHandler的添加应该遵循什么样的顺序</p>
<p>答：inbound传播是从Head结点开始的，outbound传播是从Tail节点开始的，所以需要根据需要从这两个方面选择</p>
</li>
<li>
<p>用户手动触发事件传播，不同的触发方式有什么样的区别？</p>
<p>可以这里回答：ctx.channel().write()和ctx.write()的区别，ctx.channel().write()从tail节点开始传播（对于outBound事件），ctx.write()从当前节点开始传播。</p>
</li>
</ul>
<h2 id="初始化">初始化</h2>
<p>Pipeline是在channel创建的时候进行初始化的，并且维护了双向链表，默认的添加HeadContext和TailContext，节点是AbstractChannelHandlerContext</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">protected</span> <span class="nf">AbstractChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">newId</span><span class="o">();</span>
        <span class="n">unsafe</span> <span class="o">=</span> <span class="n">newUnsafe</span><span class="o">();</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">newChannelPipeline</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="nf">DefaultChannelPipeline</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;channel&#34;</span><span class="o">);</span>
        <span class="n">succeededFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SucceededChannelFuture</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">voidPromise</span> <span class="o">=</span>  <span class="k">new</span> <span class="n">VoidChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="n">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TailContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HeadContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
        <span class="n">tail</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="channelhandlercontext">ChannelHandlerContext</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandlerContext</span> <span class="kd">extends</span> <span class="n">AttributeMap</span><span class="o">,</span> <span class="n">ChannelInboundInvoker</span><span class="o">,</span> <span class="n">ChannelOutboundInvoker</span> <span class="o">{</span>
 
    <span class="cm">/**
</span><span class="cm">     * Return the {@link Channel} which is bound to the {@link ChannelHandlerContext}.
</span><span class="cm">     */</span>
  <span class="c1">//所在的channel
</span><span class="c1"></span>    <span class="n">Channel</span> <span class="nf">channel</span><span class="o">();</span>
 
    <span class="cm">/**
</span><span class="cm">     * Returns the {@link EventExecutor} which is used to execute an arbitrary task.
</span><span class="cm">     */</span>
  <span class="c1">//哪一个loop执行的
</span><span class="c1"></span>    <span class="n">EventExecutor</span> <span class="nf">executor</span><span class="o">();</span>
 
    <span class="cm">/**
</span><span class="cm">     * The unique name of the {@link ChannelHandlerContext}.The name was used when then {@link ChannelHandler}
</span><span class="cm">     * was added to the {@link ChannelPipeline}. This name can also be used to access the registered
</span><span class="cm">     * {@link ChannelHandler} from the {@link ChannelPipeline}.
</span><span class="cm">     */</span>
    <span class="n">String</span> <span class="nf">name</span><span class="o">();</span>
 
    <span class="cm">/**
</span><span class="cm">     * The {@link ChannelHandler} that is bound this {@link ChannelHandlerContext}.
</span><span class="cm">     */</span>
  <span class="c1">//干活的业务handler
</span><span class="c1"></span>    <span class="n">ChannelHandler</span> <span class="nf">handler</span><span class="o">();</span>
 
    <span class="cm">/**
</span><span class="cm">     * Return {@code true} if the {@link ChannelHandler} which belongs to this context was removed
</span><span class="cm">     * from the {@link ChannelPipeline}. Note that this method is only meant to be called from with in the
</span><span class="cm">     * {@link EventLoop}.
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">isRemoved</span><span class="o">();</span>
    <span class="o">...</span>
    <span class="cm">/**
</span><span class="cm">     * Return the assigned {@link ByteBufAllocator} which will be used to allocate {@link ByteBuf}s.
</span><span class="cm">     */</span>
    <span class="c1">// 内存分配器
</span><span class="c1"></span>    <span class="n">ByteBufAllocator</span> <span class="nf">alloc</span><span class="o">();</span>
    <span class="o">...</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="channelhandler的添加">ChannelHandler的添加</h2>
<p>DefaultChannelPipeline的addLast方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">newCtx</span><span class="o">;</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//检查handler是否重复，如果没@Shareable的话，不可以再添加了
</span><span class="c1"></span>        <span class="n">checkMultiplicity</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>

      <span class="c1">//使用DefaultChannelHandlerContext，内部封装了具体的业务handler
</span><span class="c1"></span>        <span class="n">newCtx</span> <span class="o">=</span> <span class="n">newContext</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">filterName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="n">handler</span><span class="o">);</span>

      <span class="c1">//连接到链表上去
</span><span class="c1"></span>        <span class="n">addLast0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>

        <span class="c1">// If the registered is false it means that the channel was not registered on an eventLoop yet.
</span><span class="c1"></span>        <span class="c1">// In this case we add the context to the pipeline and add a task that will call
</span><span class="c1"></span>        <span class="c1">// ChannelHandler.handlerAdded(...) once the channel is registered.
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
            <span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">newCtx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">callHandlerAddedInEventLoop</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="n">executor</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="channelhandler删除">ChannelHandler删除</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">getContextOrDie</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="o">(</span><span class="n">AbstractChannelHandlerContext</span><span class="o">)</span> <span class="n">context</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchElementException</span><span class="o">(</span><span class="n">handler</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//从头到尾找
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelHandlerContext</span> <span class="nf">context</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;handler&#34;</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
 
            <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
 
            <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">handler</span><span class="o">()</span> <span class="o">==</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
            <span class="o">}</span>
 
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="c1">//不删除head和tail
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">remove</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">assert</span> <span class="n">ctx</span> <span class="o">!=</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">;</span>
 
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">remove0</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
 
            <span class="c1">// If the registered is false it means that the channel was not registered on an eventloop yet.
</span><span class="c1"></span>            <span class="c1">// In this case we remove the context from the pipeline and add a task that will call
</span><span class="c1"></span>            <span class="c1">// ChannelHandler.handlerRemoved(...) once the channel is registered.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
           
                <span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
            <span class="o">}</span>
 
            <span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">callHandlerRemoved0</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">callHandlerRemoved0</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//真正的删除
</span><span class="c1"></span> <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove0</span><span class="o">(</span><span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">AbstractChannelHandlerContext</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
    <span class="o">}</span>



<span class="c1">//通知删除
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">callHandlerRemoved</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Only call handlerRemoved(...) if we called handlerAdded(...) before.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">handlerState</span> <span class="o">==</span> <span class="n">ADD_COMPLETE</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">handler</span><span class="o">().</span><span class="na">handlerRemoved</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Mark the handler as removed in any case.
</span><span class="c1"></span>          <span class="c1">//标记handler删除了  
</span><span class="c1"></span>          <span class="n">setRemoved</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>



</code></pre></td></tr></table>
</div>
</div><h2 id="inboud事件">Inboud事件</h2>
<p>根据上面的描述，最终loop会绑定到pipeline中，当processSelectedKeys触发后，最后会调用到pipeline的fireChannelRead方法，找到下一个inboundHandlerContext</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">    <span class="kd">public</span> <span class="n">ChannelHandlerContext</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">invokeChannelRead</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">findContextInbound</span><span class="o">(),</span> <span class="n">msg</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>


<span class="c1">//找到下一个Inbound的handler
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">AbstractChannelHandlerContext</span> <span class="nf">findContextInbound</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">AbstractChannelHandlerContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>

        <span class="k">do</span> <span class="o">{</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">while</span><span class="o">(!</span><span class="n">ctx</span><span class="o">.</span><span class="na">inbound</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">ctx</span><span class="o">;</span>
    <span class="o">}</span>

<span class="c1">//创建handlerContext
</span><span class="c1"></span>    <span class="n">DefaultChannelHandlerContext</span><span class="o">(</span><span class="n">DefaultChannelPipeline</span> <span class="n">pipeline</span><span class="o">,</span> <span class="n">EventExecutor</span> <span class="n">executor</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
      															<span class="c1">//判断是否是inbound 
</span><span class="c1"></span>      <span class="kd">super</span><span class="o">(</span><span class="n">pipeline</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">isInbound</span><span class="o">(</span><span class="n">handler</span><span class="o">),</span> <span class="n">isOutbound</span><span class="o">(</span><span class="n">handler</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;handler&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isInbound</span><span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">handler</span> <span class="k">instanceof</span> <span class="n">ChannelInboundHandler</span><span class="o">;</span>
    <span class="o">}</span>

<span class="c1">//出发handler的方法，直接到用户的业务代码了
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">invokeHandler</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="o">((</span><span class="n">ChannelInboundHandler</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">handler</span><span class="o">()).</span><span class="na">channelRead</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">notifyHandlerException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="outbound事件">outBound事件</h2>
<p>包含bind、connect、disconnect方法、close、deregister、read、write、flush等方法，这些方法更多的是主动向用户发起的操作。</p>
<p>（而inBound事件更多的是事件的触发，如register、readComplete、active，比较被动的）</p>
<p><strong>outBound是从tail反过来在链表上传输的</strong></p>
<h2 id="ctxchannelwrite和ctxwrite的区别">ctx.channel().write()和ctx.write()的区别</h2>
<p>ctx.channel().write()从tail节点开始传播，ctx.write()从当前节点开始传播（不包括当前节点，因为它首先会找到当前节点的下一个节点在执行write操作）。</p>
<h1 id="bytebuf">ByteBuf</h1>
<ul>
<li>
<p>Pooled和Unpooled</p>
<p>池化和不池化</p>
</li>
<li>
<p>Unsafe和非Unsafe</p>
<p><strong>unsafe通过操作底层unsafe的offset+index的方式去操作数据，非unsafe直接通过一个数组的下标（或者jdk底层的buffer）去操作数据</strong>。</p>
</li>
<li>
<p>Heap和Direct</p>
<p><strong>heap是依赖一个数组，direct是依赖jdk底层的ByteBuffer</strong>。</p>
</li>
</ul>
<h1 id="bytebuffallocator">ByteBuffAllocator</h1>
<h2 id="unpooledbytebufallocator">UnpooledByteBufAllocator</h2>
<h3 id="分配堆内内存">分配堆内内存</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java">
<span class="c1">//如果jdk环境支持unsafe，则用unsafe操作内存空间
</span><span class="c1">//heap 内存空间，底层就是一个数组
</span><span class="c1"></span><span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newHeapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">()</span> <span class="o">?</span>
            <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
            <span class="k">new</span> <span class="n">InstrumentedUnpooledHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
<span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UnpooledHeapByteBuf</span><span class="o">(</span><span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">&#34;initialCapacity(%d) &gt; maxCapacity(%d)&#34;</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">alloc</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">alloc</span><span class="o">,</span> <span class="s">&#34;alloc&#34;</span><span class="o">);</span>
      <span class="c1">//声明数组
</span><span class="c1"></span>        <span class="n">setArray</span><span class="o">(</span><span class="n">allocateArray</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">));</span>
        <span class="n">setIndex</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>


<span class="c1">//创建数组
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">allocateArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">initialCapacity</span><span class="o">];</span>
    <span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="分配堆外内存">分配堆外内存</h3>
<p>底层调用jdk的<strong>DirectBuffer</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newDirectBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">noCleaner</span> <span class="o">?</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
                <span class="k">new</span> <span class="n">InstrumentedUnpooledUnsafeDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstrumentedUnpooledDirectByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">disableLeakDetector</span> <span class="o">?</span> <span class="n">buf</span> <span class="o">:</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
<span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UnpooledDirectByteBuf</span><span class="o">(</span><span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">,</span> <span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">);</span>
        <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">alloc</span><span class="o">,</span> <span class="s">&#34;alloc&#34;</span><span class="o">);</span>
        <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="s">&#34;initialCapacity&#34;</span><span class="o">);</span>
        <span class="n">checkPositiveOrZero</span><span class="o">(</span><span class="n">maxCapacity</span><span class="o">,</span> <span class="s">&#34;maxCapacity&#34;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                    <span class="s">&#34;initialCapacity(%d) &gt; maxCapacity(%d)&#34;</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">alloc</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">;</span>
        <span class="n">setByteBuffer</span><span class="o">(</span><span class="n">allocateDirect</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">ByteBuffer</span> <span class="nf">allocateDirect</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuffer</span> <span class="nf">allocateDirect</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">DirectByteBuffer</span><span class="o">(</span><span class="n">capacity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">setByteBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ByteBuffer</span> <span class="n">oldBuffer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">buffer</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oldBuffer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">doNotFree</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">doNotFree</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">freeDirect</span><span class="o">(</span><span class="n">oldBuffer</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">;</span>
        <span class="n">tmpNioBuf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">remaining</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setByteBuffer</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">tryFree</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setByteBuffer</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">tryFree</span><span class="o">);</span>
      <span class="c1">//计算内存地址，使用Unsafe去操作
</span><span class="c1"></span>        <span class="n">memoryAddress</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">directBufferAddress</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span>

		<span class="c1">//非 unsafe，直接调用jdk方法
</span><span class="c1"></span>    <span class="kd">protected</span> <span class="kt">byte</span> <span class="nf">_getByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

	<span class="c1">//获取内存地址，在用unsafe去调用
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">byte</span> <span class="nf">_getByte</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">UnsafeByteBufUtil</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">addr</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>

	<span class="c1">//计算地址
</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">long</span> <span class="nf">addr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoryAddress</span> <span class="o">+</span> <span class="n">index</span><span class="o">;</span>
    <span class="o">}</span>


</code></pre></td></tr></table>
</div>
</div><h2 id="pooledbytebufallocator">PooledByteBufAllocator</h2>
<h3 id="分配堆内内存-1">分配堆内内存</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">ByteBuf</span> <span class="nf">newHeapBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">PoolThreadCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">threadCache</span><span class="o">.</span><span class="na">get</span><span class="o">();</span><span class="c1">//取出当前线程的缓存，多线程情况下的处理
</span><span class="c1"></span>    <span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">heapArena</span><span class="o">;</span> <span class="c1">//取出当前缓存里的arena
</span><span class="c1"></span>
    <span class="kd">final</span> <span class="n">ByteBuf</span> <span class="n">buf</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">heapArena</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">heapArena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">cache</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">PlatformDependent</span><span class="o">.</span><span class="na">hasUnsafe</span><span class="o">()</span> <span class="o">?</span>
                <span class="k">new</span> <span class="n">UnpooledUnsafeHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">)</span> <span class="o">:</span>
                <span class="k">new</span> <span class="n">UnpooledHeapByteBuf</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="n">maxCapacity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">toLeakAwareBuffer</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
<span class="o">}</span>



    <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PoolThreadLocalCache</span> <span class="kd">extends</span> <span class="n">FastThreadLocal</span><span class="o">&lt;</span><span class="n">PoolThreadCache</span><span class="o">&gt;</span> <span class="o">{</span>
 
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">PoolThreadCache</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">heapArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">heapArenas</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">PoolArena</span><span class="o">&lt;</span><span class="n">ByteBuffer</span><span class="o">&gt;</span> <span class="n">directArena</span> <span class="o">=</span> <span class="n">leastUsedArena</span><span class="o">(</span><span class="n">directArenas</span><span class="o">);</span>
 
          <span class="c1">//FastThreadLocal就是ThreacLocal的快速版本，首次没有取到缓存的时候，会进行初始化动作
</span><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">PoolThreadCache</span><span class="o">(</span>
                    <span class="n">heapArena</span><span class="o">,</span> <span class="n">directArena</span><span class="o">,</span> <span class="n">tinyCacheSize</span><span class="o">,</span> <span class="n">smallCacheSize</span><span class="o">,</span> <span class="n">normalCacheSize</span><span class="o">,</span>
                    <span class="n">DEFAULT_MAX_CACHED_BUFFER_CAPACITY</span><span class="o">,</span> <span class="n">DEFAULT_CACHE_TRIM_INTERVAL</span><span class="o">);</span>
        <span class="o">}</span>
     <span class="o">...</span>
<span class="o">}</span>


</code></pre></td></tr></table>
</div>
</div><h1 id="bytetomessagedecoder">ByteToMessageDecoder</h1>
<p>抽象的字节解码器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="n">ByteBuf</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">CodecOutputList</span> <span class="n">out</span> <span class="o">=</span> <span class="n">CodecOutputList</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">cumulation</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
          <span class="c1">//检查是否要扩容，默认netty实现是合并到一个ByteBuf上，需要内存复制，另一种是直接创建一个新的compositeByteBuf
</span><span class="c1"></span>            <span class="n">cumulation</span> <span class="o">=</span> <span class="n">cumulator</span><span class="o">.</span><span class="na">cumulate</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">alloc</span><span class="o">(),</span>
                    <span class="n">first</span> <span class="o">?</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span> <span class="o">:</span> <span class="n">cumulation</span><span class="o">,</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">);</span>
            <span class="n">callDecode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cumulation</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DecoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">DecoderException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">cumulation</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cumulation</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">numReads</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="n">cumulation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">cumulation</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(++</span><span class="n">numReads</span> <span class="o">&gt;=</span> <span class="n">discardAfterReads</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// We did enough reads already try to discard some bytes so we not risk to see a OOME.
</span><span class="c1"></span>                    <span class="c1">// See https://github.com/netty/netty/issues/4275
</span><span class="c1"></span>                    <span class="n">numReads</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="n">discardSomeReadBytes</span><span class="o">();</span>
                <span class="o">}</span>

                <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                <span class="n">firedChannelRead</span> <span class="o">|=</span> <span class="n">out</span><span class="o">.</span><span class="na">insertSinceRecycled</span><span class="o">();</span>
                <span class="n">fireChannelRead</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1">//默认Cumulator实现，内存复制到一个ByteBuf上
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Cumulator</span> <span class="n">MERGE_CUMULATOR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cumulator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">ByteBuf</span> <span class="nf">cumulate</span><span class="o">(</span><span class="n">ByteBufAllocator</span> <span class="n">alloc</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">cumulation</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">cumulation</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="o">.</span><span class="na">isContiguous</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// If cumulation is empty and input buffer is contiguous, use it directly
</span><span class="c1"></span>                <span class="n">cumulation</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="k">return</span> <span class="n">in</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">required</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">required</span> <span class="o">&gt;</span> <span class="n">cumulation</span><span class="o">.</span><span class="na">maxWritableBytes</span><span class="o">()</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">required</span> <span class="o">&gt;</span> <span class="n">cumulation</span><span class="o">.</span><span class="na">maxFastWritableBytes</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">cumulation</span><span class="o">.</span><span class="na">refCnt</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">||</span>
                        <span class="n">cumulation</span><span class="o">.</span><span class="na">isReadOnly</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// Expand cumulation (by replacing it) under the following conditions:
</span><span class="c1"></span>                    <span class="c1">// - cumulation cannot be resized to accommodate the additional data
</span><span class="c1"></span>                    <span class="c1">// - cumulation can be expanded with a reallocation operation to accommodate but the buffer is
</span><span class="c1"></span>                    <span class="c1">//   assumed to be shared (e.g. refCnt() &gt; 1) and the reallocation may not be safe.
</span><span class="c1"></span>                    <span class="k">return</span> <span class="n">expandCumulation</span><span class="o">(</span><span class="n">alloc</span><span class="o">,</span> <span class="n">cumulation</span><span class="o">,</span> <span class="n">in</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">cumulation</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">in</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(),</span> <span class="n">required</span><span class="o">);</span>
                <span class="n">in</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">());</span>
                <span class="k">return</span> <span class="n">cumulation</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// We must release in in all cases as otherwise it may produce a leak if writeBytes(...) throw
</span><span class="c1"></span>                <span class="c1">// for whatever release (for example because of OutOfMemoryError)
</span><span class="c1"></span>                <span class="n">in</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">callDecode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">outSize</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>

          <span class="c1">//解析到了数据
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">outSize</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">//通知到下一个handler
</span><span class="c1"></span>                <span class="n">fireChannelRead</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="n">outSize</span><span class="o">);</span>
                <span class="n">out</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

                <span class="c1">// Check if this handler was removed before continuing with decoding.
</span><span class="c1"></span>                <span class="c1">// If it was removed, it is not safe to continue to operate on the buffer.
</span><span class="c1"></span>                <span class="c1">//
</span><span class="c1"></span>                <span class="c1">// See:
</span><span class="c1"></span>                <span class="c1">// - https://github.com/netty/netty/issues/4635
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">isRemoved</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="kt">int</span> <span class="n">oldInputLength</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span>
          <span class="c1">//子类实现decode
</span><span class="c1"></span>            <span class="n">decodeRemovalReentryProtection</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">in</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>

            <span class="c1">// Check if this handler was removed before continuing the loop.
</span><span class="c1"></span>            <span class="c1">// If it was removed, it is not safe to continue to operate on the buffer.
</span><span class="c1"></span>            <span class="c1">//
</span><span class="c1"></span>            <span class="c1">// See https://github.com/netty/netty/issues/1664
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">isRemoved</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

          <span class="c1">//如果子类没有解析到对象
</span><span class="c1"></span>          <span class="c1">//  1 数据不够解析道对象的
</span><span class="c1"></span>          <span class="c1">//  2 
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">out</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
              
              <span class="c1">//数据不够解析的，跳出while，等下一次继续
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">oldInputLength</span> <span class="o">==</span> <span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="c1">// 解析出来的东西，不够合成一个对象的，继续解析
</span><span class="c1"></span>                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

          <span class="c1">// 解析出对象了，但是数据没有减少，有问题啊，明显对象你自己搞出来的，不是从数据里拿的，你有问题
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">oldInputLength</span> <span class="o">==</span> <span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">DecoderException</span><span class="o">(</span>
                        <span class="n">StringUtil</span><span class="o">.</span><span class="na">simpleClassName</span><span class="o">(</span><span class="n">getClass</span><span class="o">())</span> <span class="o">+</span>
                                <span class="s">&#34;.decode() did not read anything but decoded a message.&#34;</span><span class="o">);</span>
            <span class="o">}</span>
				
          <span class="c1">// 如果只要解析一个，直接跳出
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">isSingleDecode</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DecoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">DecoderException</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">sh</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-10-13
        <a href="https://github.com/sunhao1256/sunhao1256.github.io/commit/31cf7f52a18d1a9b5c992b3815bb95f33f15fb6b" title="update">(31cf7f5)</a>
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/netty/">Netty</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go包管理</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/reactor/">
            <span class="next-text nav-default">Reactor响应式编程</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:sunhao1256@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/Frank12990735" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/sunhao1256" class="iconfont icon-github" title="github"></a>
  <a href="http://luluhome.site/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>sh</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
